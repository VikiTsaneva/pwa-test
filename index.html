<!DOCTYPE html>
<html lang="bg">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Parkly - Намерете свободни паркоместа</title>
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json">
    
    <!-- Apple touch icons за iOS -->
    <link rel="apple-touch-icon" href="icons/icon-192x192.png">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Parkly">
    
    <!-- Theme color -->
    <meta name="theme-color" content="#2c3e50">
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* ========== ВСИЧКИ CSS СТИЛОВЕ ========== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        /* Светла тема (по подразбиране) */
        :root {
            --primary: #2c3e50;
            --secondary: #3498db;
            --accent: #e74c3c;
            --light: #ecf0f1;
            --dark: #2c3e50;
            --success: #27ae60;
            --warning: #f39c12;
            --bg-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --bg-color: #f5f5f5;
            --text-color: #333333;
            --text-secondary: #666666;
            --card-bg: #ffffff;
            --header-bg: #ffffff;
            --sidebar-bg: #2c3e50;
            --sidebar-text: #ffffff;
            --border-color: #e9ecef;
            --input-bg: #ffffff;
            --input-border: #e9ecef;
            --stat-bg: #f8f9fa;
            --hover-bg: rgba(0,0,0,0.05);
            --map-title-bg: rgba(255,255,255,0.95);
            --status-panel-bg: rgba(255,255,255,0.98);
            --legend-bg: rgba(255,255,255,0.95);
            --contact-modal-bg: #ffffff;
            --contact-info-bg: #f8f9fa;
            --link-color: #667eea;
            --icon-color: #667eea;
            --status-badge-bg: #eef2f6;
            --status-badge-text: #2c3e50;
            --restricted-opacity: 0.4;
            --admin-badge: #ffc107;
            --admin-text: #000000;
            --favorite: #ffc107;
            --favorite-hover: #ffb300;
        }

        /* Тъмна тема */
        body.dark-theme {
            --primary: #3498db;
            --secondary: #667eea;
            --accent: #e74c3c;
            --light: #2d2d2d;
            --dark: #1a1a1a;
            --success: #27ae60;
            --warning: #f39c12;
            --bg-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --bg-color: #1a1a1a;
            --text-color: #ffffff;
            --text-secondary: #cccccc;
            --card-bg: #2d2d2d;
            --header-bg: #2d2d2d;
            --sidebar-bg: #2c3e50;
            --sidebar-text: #ffffff;
            --border-color: #404040;
            --input-bg: #3d3d3d;
            --input-border: #404040;
            --stat-bg: #363636;
            --hover-bg: rgba(255,255,255,0.1);
            --map-title-bg: rgba(45,45,45,0.95);
            --status-panel-bg: rgba(45,45,45,0.98);
            --legend-bg: rgba(45,45,45,0.95);
            --contact-modal-bg: #2d2d2d;
            --contact-info-bg: #363636;
            --link-color: #667eea;
            --icon-color: #667eea;
            --status-badge-bg: #404040;
            --status-badge-text: #ffffff;
            --admin-badge: #ffc107;
            --admin-text: #000000;
            --favorite: #ffc107;
            --favorite-hover: #ffb300;
        }

        body {
            background-color: var(--bg-color);
            color: var(--text-color);
            line-height: 1.6;
            height: 100vh;
            overflow: hidden;
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        .container {
            display: flex;
            height: 100vh;
            overflow: hidden;
        }

        /* Сайдбар */
        .sidebar {
            width: 250px;
            background-color: var(--sidebar-bg);
            color: var(--sidebar-text);
            display: flex;
            flex-direction: column;
            transition: width 0.3s ease, background-color 0.3s ease;
            box-shadow: 2px 0 10px rgba(0, 0, 0, 0.1);
            z-index: 10;
        }

        .sidebar-header {
            padding: 20px;
            background-color: rgba(0, 0, 0, 0.2);
            text-align: center;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .sidebar-header h2 {
            font-size: 1.5rem;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .sidebar-header .logo-icon {
            width: 40px;
            height: 40px;
            margin-right: 10px;
            vertical-align: middle;
            display: inline-block;
            background: transparent;
            filter: none;
        }

        .sidebar-header img.logo-icon {
            width: 40px;
            height: 40px;
            object-fit: contain;
            -webkit-backface-visibility: hidden;
            backface-visibility: hidden;
            image-rendering: optimizeQuality;
            filter: drop-shadow(0 2px 2px rgba(0,0,0,0.25));
        }

        .nav-menu {
            flex: 1;
            padding: 20px 0;
        }

        .nav-item {
            padding: 15px 20px;
            display: flex;
            align-items: center;
            cursor: pointer;
            transition: all 0.3s ease;
            border-left: 4px solid transparent;
            color: var(--sidebar-text);
        }

        .nav-item:hover, .nav-item.active {
            background-color: rgba(255, 255, 255, 0.1);
            border-left-color: var(--secondary);
        }

        .nav-item i {
            margin-right: 15px;
            font-size: 1.2rem;
            width: 24px;
            text-align: center;
            color: var(--secondary);
        }

        .user-info {
            padding: 20px;
            background-color: rgba(0, 0, 0, 0.2);
            display: flex;
            align-items: center;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            cursor: pointer;
            transition: background-color 0.3s ease;
        }

        .user-info:hover {
            background-color: rgba(0, 0, 0, 0.3);
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: var(--secondary);
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 10px;
            font-weight: bold;
            color: white;
        }

        .user-name {
            color: white;
            font-weight: 600;
        }

        .user-status {
            color: rgba(255, 255, 255, 0.7);
            font-size: 0.9rem;
        }

        /* Основно съдържание */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            position: relative;
        }

        .header {
            background-color: var(--header-bg);
            padding: 15px 30px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: background-color 0.3s ease;
        }

        .header h1 {
            color: var(--primary);
            font-size: 1.8rem;
            transition: color 0.3s ease;
        }

        .search-bar {
            display: flex;
            width: 300px;
        }

        .search-bar input {
            flex: 1;
            padding: 10px 15px;
            border: 1px solid var(--input-border);
            border-radius: 4px 0 0 4px;
            font-size: 1rem;
            background-color: var(--input-bg);
            color: var(--text-color);
            transition: background-color 0.3s ease, border-color 0.3s ease, color 0.3s ease;
        }

        .search-bar input::placeholder {
            color: var(--text-secondary);
        }

        .search-bar button {
            background-color: var(--secondary);
            color: white;
            border: none;
            padding: 0 20px;
            border-radius: 0 4px 4px 0;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }

        .search-bar button:hover {
            background-color: var(--primary);
        }

        .content-area {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            position: relative;
            height: 100%;
        }

        /* Страници */
        .page {
            display: none;
            height: 100%;
            animation: fadeIn 0.5s;
        }

        .page.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        /* Карта */
        #map {
            height: 100%;
            width: 100%;
            background: #c8e0f0;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            z-index: 1;
        }

        .map-container {
            height: 100%;
            position: relative;
        }

        /* Заглавие на картата */
        .map-title {
            position: absolute;
            top: 20px;
            left: 20px;
            z-index: 1000;
            background: var(--map-title-bg);
            padding: 16px 24px;
            border-radius: 16px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            text-align: left;
            min-width: 280px;
            -webkit-backdrop-filter: blur(8px);
            backdrop-filter: blur(8px);
            border-left: 5px solid var(--secondary);
            pointer-events: none;
            transition: background-color 0.3s ease;
        }
        
        .map-title h2 {
            color: var(--text-color);
            font-size: 1.4rem;
            margin-bottom: 4px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: color 0.3s ease;
        }
        
        .map-title h2 i {
            color: var(--secondary);
        }
        
        .map-title p {
            color: var(--text-secondary);
            font-size: 0.95rem;
            margin: 0;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: color 0.3s ease;
        }
        
        .map-title p i {
            color: var(--success);
            font-size: 14px;
        }
        
        /* Статус панел */
        .status-panel.restricted {
            filter: blur(4px);
            opacity: var(--restricted-opacity);
            pointer-events: none;
            user-select: none;
        }
        
        .status-panel {
            position: absolute;
            top: 20px;
            right: 20px;
            background: var(--status-panel-bg);
            padding: 20px;
            border-radius: 20px;
            box-shadow: 0 8px 30px rgba(0,0,0,0.12);
            z-index: 1000;
            min-width: 260px;
            -webkit-backdrop-filter: blur(8px);
            backdrop-filter: blur(8px);
            border: 1px solid var(--border-color);
            pointer-events: none;
            transition: background-color 0.3s ease, border-color 0.3s ease, filter 0.3s ease, opacity 0.3s ease;
        }
        
        .status-panel:not(.restricted) {
            pointer-events: auto;
        }
        
        .status-title {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 16px;
            color: var(--text-color);
            display: flex;
            align-items: center;
            gap: 8px;
            padding-bottom: 12px;
            border-bottom: 2px solid var(--border-color);
            transition: color 0.3s ease, border-color 0.3s ease;
        }
        
        .status-title i {
            color: var(--secondary);
        }
        
        .status-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            padding: 8px 12px;
            border-radius: 12px;
            transition: all 0.2s;
        }
        
        .spot-number {
            font-weight: 600;
            color: var(--text-color);
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.95rem;
            transition: color 0.3s ease;
        }
        
        .spot-badge {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 28px;
            height: 28px;
            border-radius: 10px;
            background: var(--status-badge-bg);
            color: var(--status-badge-text);
            font-weight: 700;
            font-size: 0.9rem;
            transition: background-color 0.3s ease, color 0.3s ease;
        }
        
        .disabled-badge {
            background: rgba(52, 152, 219, 0.2);
            color: var(--secondary);
        }
        
        .disabled-badge i {
            font-size: 14px;
        }
        
        .status-value {
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 600;
            font-size: 0.95rem;
            padding: 4px 12px;
            border-radius: 30px;
        }
        
        .status-value i {
            font-size: 12px;
        }
        
        .status-empty {
            background: rgba(39, 174, 96, 0.15);
            color: var(--success);
        }
        
        .status-occupied {
            background: rgba(231, 76, 60, 0.15);
            color: var(--accent);
        }
        
        .status-disabled-empty {
            background: rgba(52, 152, 219, 0.15);
            color: var(--secondary);
        }
        
        .status-disabled-occupied {
            background: rgba(231, 76, 60, 0.15);
            color: var(--accent);
        }
        
        .status-pending {
            background: rgba(243, 156, 18, 0.15);
            color: var(--warning);
        }
        
        .last-update {
            font-size: 0.8rem;
            color: var(--text-secondary);
            text-align: center;
            margin-top: 16px;
            padding-top: 12px;
            border-top: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            transition: color 0.3s ease, border-color 0.3s ease;
        }
        
        .last-update i {
            color: var(--secondary);
            font-size: 12px;
        }
        
        /* Login prompt в статус панела */
        .login-prompt {
            margin-top: 16px;
            padding: 12px;
            background: rgba(52, 152, 219, 0.1);
            border-radius: 12px;
            text-align: center;
            font-size: 0.9rem;
            color: var(--text-color);
            border: 1px dashed var(--secondary);
            pointer-events: auto;
        }
        
        .login-prompt a {
            color: var(--secondary);
            font-weight: 600;
            text-decoration: none;
            cursor: pointer;
        }
        
        .login-prompt a:hover {
            text-decoration: underline;
        }
        
        /* Долен панел с информация */
        .info-footer {
            position: absolute;
            bottom: 20px;
            left: 20px;
            right: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 1000;
            pointer-events: none;
        }
        
        .parking-stats {
            background: var(--status-panel-bg);
            padding: 12px 20px;
            border-radius: 40px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            display: flex;
            align-items: center;
            gap: 20px;
            -webkit-backdrop-filter: blur(8px);
            backdrop-filter: blur(8px);
            pointer-events: auto;
            transition: background-color 0.3s ease;
            border: 1px solid var(--border-color);
        }
        
        .stat-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .stat-item i {
            font-size: 1.1rem;
            color: var(--secondary);
        }
        
        .stat-item .label {
            color: var(--text-secondary);
            font-size: 0.9rem;
            transition: color 0.3s ease;
        }
        
        .stat-item .value {
            font-weight: 700;
            color: var(--text-color);
            transition: color 0.3s ease;
        }
        
        .controls {
            background: var(--status-panel-bg);
            padding: 8px;
            border-radius: 40px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            pointer-events: auto;
            transition: background-color 0.3s ease;
            border: 1px solid var(--border-color);
            -webkit-backdrop-filter: blur(8px);
            backdrop-filter: blur(8px);
        }
        
        .controls button {
            background: var(--secondary);
            color: white;
            border: none;
            padding: 10px 24px;
            border-radius: 40px;
            cursor: pointer;
            font-size: 0.95rem;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.2s;
            border: 1px solid rgba(255,255,255,0.2);
        }
        
        .controls button:hover {
            background: var(--primary);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.3);
        }
        
        .controls button i {
            font-size: 1rem;
        }
        
        /* Легенда */
        .legend {
            position: absolute;
            bottom: 20px;
            right: 20px;
            background: var(--legend-bg);
            padding: 12px 16px;
            border-radius: 16px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            z-index: 1000;
            font-size: 0.85rem;
            -webkit-backdrop-filter: blur(8px);
            backdrop-filter: blur(8px);
            pointer-events: auto;
            transition: background-color 0.3s ease;
            border: 1px solid var(--border-color);
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 6px;
            color: var(--text-color);
            transition: color 0.3s ease;
        }
        
        .legend-item:last-child {
            margin-bottom: 0;
        }
        
        .legend-color {
            width: 20px;
            height: 20px;
            border-radius: 6px;
        }
        
        .legend-color.blue {
            background: var(--secondary);
            opacity: 0.7;
        }
        
        .legend-color.green {
            background: var(--success);
            opacity: 0.7;
        }
        
        .legend-color.red {
            background: var(--accent);
            opacity: 0.7;
        }
        
        .legend-color.yellow {
            background: var(--favorite);
            opacity: 0.7;
        }

        .icon-success {
            color: var(--success);
        }

        /* Стилове за профил */
        .profile-container {
            max-width: 900px;
            margin: 0 auto;
            background: var(--card-bg);
            border-radius: 20px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            transition: background-color 0.3s ease;
            border: 1px solid var(--border-color);
        }

        .profile-header {
            background: var(--bg-gradient);
            padding: 30px;
            color: white;
            display: flex;
            align-items: center;
            gap: 30px;
        }

        .profile-avatar-large {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            background: white;
            color: var(--secondary);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 3rem;
            font-weight: bold;
            border: 4px solid rgba(255,255,255,0.3);
        }

        .profile-header-info h2 {
            font-size: 2rem;
            margin-bottom: 5px;
            color: white;
        }

        .profile-header-info p {
            opacity: 0.9;
            display: flex;
            align-items: center;
            gap: 10px;
            color: white;
        }

        .profile-details {
            padding: 30px;
        }

        .profile-details h3 {
            margin-bottom: 20px;
            color: var(--text-color);
            display: flex;
            align-items: center;
            gap: 10px;
            transition: color 0.3s ease;
        }

        .profile-details h3 i {
            color: var(--secondary);
        }

        .details-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
        }

        .detail-item {
            display: flex;
            flex-direction: column;
        }

        .detail-item label {
            font-size: 0.9rem;
            color: var(--text-secondary);
            margin-bottom: 5px;
            transition: color 0.3s ease;
        }

        .detail-item .detail-value {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--text-color);
            padding: 10px;
            background: var(--stat-bg);
            border-radius: 10px;
            border: 1px solid var(--border-color);
            transition: background-color 0.3s ease, border-color 0.3s ease, color 0.3s ease;
        }

        .edit-profile-btn {
            background: var(--bg-gradient);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            margin-top: 20px;
            display: inline-flex;
            align-items: center;
            gap: 10px;
            transition: all 0.3s ease;
        }

        .edit-profile-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }

        /* Модален прозорец */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 10000;
            align-items: center;
            justify-content: center;
            padding: 20px;
            backdrop-filter: blur(5px);
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal-content {
            background: var(--card-bg);
            border-radius: 20px;
            padding: 30px;
            max-width: 500px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            border: 1px solid var(--border-color);
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            animation: modalSlideIn 0.3s ease;
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(-30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .modal-content h3 {
            margin-bottom: 20px;
            color: var(--text-color);
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 1.5rem;
        }

        .modal-content h3 i {
            color: var(--secondary);
        }

        .user-detail-item {
            margin-bottom: 15px;
            padding: 15px;
            background: var(--stat-bg);
            border-radius: 12px;
            border: 1px solid var(--border-color);
        }

        .user-detail-label {
            font-size: 0.85rem;
            color: var(--text-secondary);
            margin-bottom: 5px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .user-detail-value {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--text-color);
            word-break: break-word;
        }

        .user-detail-value i {
            color: var(--secondary);
            margin-right: 8px;
        }

        .modal-actions {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .modal-actions button {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
            font-size: 1rem;
        }

        .modal-actions button:hover {
            transform: translateY(-2px);
        }

        .modal-actions .close-btn {
            background: var(--secondary);
            color: white;
        }

        .modal-actions .danger-btn {
            background: var(--accent);
            color: white;
        }

        .edit-modal-content .form-group {
            margin-bottom: 15px;
        }

        .edit-modal-content label {
            display: block;
            margin-bottom: 5px;
            color: var(--text-secondary);
        }

        .edit-modal-content input {
            width: 100%;
            padding: 10px;
            border: 2px solid var(--input-border);
            border-radius: 10px;
            background: var(--input-bg);
            color: var(--text-color);
        }

        .edit-modal-actions {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .edit-modal-actions button {
            flex: 1;
            padding: 10px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }

        .edit-modal-actions .save-btn {
            background: var(--success);
            color: white;
        }

        .edit-modal-actions .cancel-btn {
            background: var(--accent);
            color: white;
        }

        /* Бутони */
        .btn {
            display: inline-block;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 12px 30px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: all 0.3s ease;
            text-decoration: none;
            text-align: center;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-block {
            display: block;
            width: 100%;
        }

        .btn i {
            margin-right: 8px;
        }

        .btn-favorite {
            background: var(--favorite);
            color: black;
        }

        .btn-favorite:hover {
            background: var(--favorite-hover);
        }

        .btn-navigate {
            background: var(--success);
            color: white;
        }

        .btn-navigate:hover {
            background: #219a52;
        }

        /* Стилове за вход */
        .auth-container {
            max-width: 450px;
            margin: 0 auto;
            background: var(--card-bg);
            border-radius: 20px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            transition: background-color 0.3s ease;
            border: 1px solid var(--border-color);
        }

        .auth-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 30px;
            text-align: center;
            color: white;
        }

        .auth-header i {
            font-size: 3rem;
            margin-bottom: 15px;
            background: rgba(255,255,255,0.2);
            width: 80px;
            height: 80px;
            line-height: 80px;
            border-radius: 50%;
            display: inline-block;
        }

        .auth-header h2 {
            font-size: 1.8rem;
            margin-bottom: 5px;
            color: white;
        }

        .auth-header p {
            color: rgba(255,255,255,0.9);
        }

        .auth-form {
            padding: 30px;
        }

        .auth-form .form-group {
            margin-bottom: 20px;
        }

        .auth-form .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--text-color);
            transition: color 0.3s ease;
        }

        .auth-form .form-group input {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid var(--input-border);
            border-radius: 10px;
            font-size: 1rem;
            background-color: var(--input-bg);
            color: var(--text-color);
            transition: all 0.3s ease;
        }

        .auth-form .form-group input::placeholder {
            color: var(--text-secondary);
        }

        .auth-form .form-group input:focus {
            outline: none;
            border-color: var(--secondary);
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .auth-btn {
            width: 100%;
            padding: 14px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 15px;
        }

        .auth-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .auth-links {
            text-align: center;
            margin-top: 20px;
        }

        .auth-links a {
            color: var(--link-color);
            text-decoration: none;
            font-weight: 600;
            transition: color 0.3s ease;
        }

        .auth-links a:hover {
            text-decoration: underline;
        }

        .auth-links.auth-links-margin {
            margin-top: 20px;
        }

        .auth-divider {
            display: flex;
            align-items: center;
            text-align: center;
            margin: 20px 0;
            color: var(--text-secondary);
            transition: color 0.3s ease;
        }

        .auth-divider::before,
        .auth-divider::after {
            content: '';
            flex: 1;
            border-bottom: 1px solid var(--border-color);
            transition: border-color 0.3s ease;
        }

        .auth-divider span {
            padding: 0 10px;
        }

        .social-login {
            display: flex;
            gap: 10px;
            justify-content: center;
        }

        .social-btn {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            border: 2px solid var(--border-color);
            background: var(--input-bg);
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 1.3rem;
            color: var(--text-color);
        }

        .social-btn:hover {
            transform: translateY(-2px);
            border-color: var(--secondary);
            color: var(--secondary);
        }

        /* Стилове за регистрация */
        .register-container {
            max-width: 600px;
            margin: 0 auto;
            background: var(--card-bg);
            border-radius: 20px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            transition: background-color 0.3s ease;
            border: 1px solid var(--border-color);
        }

        .register-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 30px;
            text-align: center;
            color: white;
        }

        .register-header i {
            font-size: 3rem;
            margin-bottom: 15px;
            background: rgba(255,255,255,0.2);
            width: 80px;
            height: 80px;
            line-height: 80px;
            border-radius: 50%;
            display: inline-block;
        }

        .register-header h2 {
            font-size: 1.8rem;
            margin-bottom: 5px;
            color: white;
        }

        .register-header p {
            color: rgba(255,255,255,0.9);
        }

        .register-form {
            padding: 30px;
        }

        .register-form .form-row {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
        }

        .register-form .form-group {
            flex: 1;
            margin-bottom: 0;
        }

        .register-form .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--text-color);
            transition: color 0.3s ease;
        }

        .register-form .form-group input {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid var(--input-border);
            border-radius: 10px;
            font-size: 1rem;
            background-color: var(--input-bg);
            color: var(--text-color);
            transition: all 0.3s ease;
        }

        .register-form .form-group input::placeholder {
            color: var(--text-secondary);
        }

        .register-form .form-group input:focus {
            outline: none;
            border-color: var(--secondary);
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .terms-checkbox {
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 20px 0;
            color: var(--text-color);
            transition: color 0.3s ease;
        }

        .terms-checkbox input {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }

        .terms-checkbox label {
            color: var(--text-color);
            transition: color 0.3s ease;
            font-size: 0.95rem;
        }

        .terms-checkbox a {
            color: var(--link-color);
            text-decoration: none;
        }

        /* Списъци - Любими */
        .favorites-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .favorite-card {
            background-color: var(--card-bg);
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.05);
            transition: all 0.3s ease;
            border: 1px solid var(--border-color);
        }

        .favorite-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
        }

        .favorite-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .favorite-name {
            font-size: 1.3rem;
            font-weight: 600;
            color: var(--text-color);
            transition: color 0.3s ease;
        }

        .favorite-card p {
            color: var(--text-secondary);
            transition: color 0.3s ease;
        }

        .favorite-card p i {
            color: var(--secondary);
            margin-right: 8px;
        }

        .favorite-status {
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: bold;
        }

        .status-free {
            background-color: rgba(39, 174, 96, 0.15);
            color: var(--success);
        }

        .status-busy {
            background-color: rgba(231, 76, 60, 0.15);
            color: var(--accent);
        }

        .favorite-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .favorite-actions button {
            flex: 1;
            padding: 8px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
            font-size: 0.9rem;
        }

        .favorite-actions button i {
            margin-right: 5px;
        }

        .favorite-actions .navigate-btn {
            background: var(--success);
            color: white;
        }

        .favorite-actions .remove-btn {
            background: var(--accent);
            color: white;
        }

        /* Настройки */
        .settings-list {
            background-color: var(--card-bg);
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.05);
            transition: background-color 0.3s ease;
            border: 1px solid var(--border-color);
        }

        .setting-item {
            padding: 20px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: border-color 0.3s ease;
            flex-wrap: wrap;
            gap: 15px;
        }

        .setting-item:last-child {
            border-bottom: none;
        }

        .setting-info {
            flex: 1;
            min-width: 200px;
        }

        .setting-info h4 {
            color: var(--text-color);
            margin-bottom: 5px;
            transition: color 0.3s ease;
            font-size: 1.1rem;
        }

        .setting-info p {
            color: var(--text-secondary);
            font-size: 0.9rem;
            transition: color 0.3s ease;
        }

        .toggle-switch {
            position: relative;
            width: 60px;
            height: 30px;
            flex-shrink: 0;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 34px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 22px;
            width: 22px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .slider {
            background-color: var(--secondary);
        }

        input:checked + .slider:before {
            transform: translateX(30px);
        }

        select {
            background-color: var(--input-bg);
            color: var(--text-color);
            border: 1px solid var(--border-color);
            padding: 8px 12px;
            border-radius: 8px;
            transition: all 0.3s ease;
            font-size: 1rem;
            cursor: pointer;
            min-width: 120px;
        }

        select option {
            background-color: var(--card-bg);
            color: var(--text-color);
        }

        /* Балонче за контакти */
        .contact-bubble {
            position: fixed;
            bottom: 30px;
            right: 30px;
            width: 60px;
            height: 60px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.8rem;
            cursor: pointer;
            box-shadow: 0 5px 20px rgba(0,0,0,0.4);
            transition: all 0.3s ease;
            z-index: 2000;
            animation: pulse 2s infinite;
        }

        .contact-bubble:hover {
            transform: scale(1.1) translateY(-5px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.6);
            animation: none;
        }

        @keyframes pulse {
            0% {
                box-shadow: 0 5px 20px rgba(0,0,0,0.4);
            }
            50% {
                box-shadow: 0 5px 30px rgba(0,0,0,0.8);
            }
            100% {
                box-shadow: 0 5px 20px rgba(0,0,0,0.4);
            }
        }

        /* Модален прозорец за контакти */
        .contact-modal {
            position: fixed;
            bottom: 100px;
            right: 30px;
            width: 350px;
            background: var(--contact-modal-bg);
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
            z-index: 2001;
            display: none;
            overflow: hidden;
            animation: slideIn 0.3s ease;
            transition: background-color 0.3s ease;
            border: 1px solid var(--border-color);
            -webkit-backdrop-filter: blur(8px);
            backdrop-filter: blur(8px);
        }

        .contact-modal.active {
            display: block;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .modal-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h3 {
            font-size: 1.2rem;
            display: flex;
            align-items: center;
            gap: 10px;
            color: white;
        }

        .modal-header h3 i {
            color: white;
        }

        .modal-close {
            background: none;
            border: none;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: all 0.3s ease;
        }

        .modal-close:hover {
            background-color: rgba(255, 255, 255, 0.2);
        }

        .modal-body {
            padding: 20px;
        }

        .contact-form {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .contact-form textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid var(--input-border);
            border-radius: 10px;
            font-size: 1rem;
            min-height: 120px;
            resize: vertical;
            background-color: var(--input-bg);
            color: var(--text-color);
            transition: all 0.3s ease;
        }

        .contact-form textarea::placeholder {
            color: var(--text-secondary);
        }

        .contact-form textarea:focus {
            outline: none;
            border-color: var(--secondary);
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .contact-info {
            background: var(--contact-info-bg);
            padding: 15px;
            border-radius: 10px;
            margin-top: 15px;
            transition: background-color 0.3s ease;
        }

        .contact-info p {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
            color: var(--text-color);
            transition: color 0.3s ease;
        }

        .contact-info p:last-child {
            margin-bottom: 0;
        }

        .contact-info i {
            color: var(--secondary);
            width: 20px;
        }

        /* Инсталационен банер за PWA */
        .install-banner {
            position: fixed;
            bottom: 100px;
            left: 20px;
            right: 20px;
            background: var(--card-bg);
            border-radius: 16px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            padding: 16px;
            display: none;
            align-items: center;
            justify-content: space-between;
            z-index: 3000;
            border: 1px solid var(--border-color);
            max-width: 400px;
            margin: 0 auto;
            animation: slideUp 0.3s ease;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .install-banner-content {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .install-banner-icon {
            width: 48px;
            height: 48px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.8rem;
        }

        .install-banner-text h4 {
            color: var(--text-color);
            margin-bottom: 4px;
            font-size: 1rem;
        }

        .install-banner-text p {
            color: var(--text-secondary);
            font-size: 0.85rem;
        }

        .install-banner-actions {
            display: flex;
            gap: 8px;
        }

        .install-banner-btn {
            background: var(--secondary);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            font-size: 0.9rem;
        }

        .install-banner-close {
            background: transparent;
            border: none;
            color: var(--text-secondary);
            font-size: 1.2rem;
            cursor: pointer;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Стилове за админ панел */
        .admin-container {
            max-width: 1200px;
            margin: 0 auto;
            background: var(--card-bg);
            border-radius: 20px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
            padding: 20px;
            transition: background-color 0.3s ease;
            border: 1px solid var(--border-color);
        }

        .admin-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .admin-stat-card {
            background: var(--stat-bg);
            padding: 20px;
            border-radius: 15px;
            text-align: center;
            border: 1px solid var(--border-color);
            transition: transform 0.3s;
        }

        .admin-stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
        }

        .admin-stat-number {
            font-size: 2.5em;
            font-weight: bold;
            color: var(--secondary);
        }

        .admin-stat-label {
            color: var(--text-secondary);
            margin-top: 10px;
            font-size: 14px;
        }

        .users-table {
            background: var(--card-bg);
            border-radius: 15px;
            padding: 20px;
            border: 1px solid var(--border-color);
            overflow-x: auto;
        }

        .users-table h2 {
            margin-bottom: 20px;
            color: var(--text-color);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .users-table table {
            width: 100%;
            border-collapse: collapse;
            min-width: 900px;
        }

        .users-table th, .users-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
            color: var(--text-color);
            font-size: 0.9rem;
        }

        .users-table th {
            background-color: var(--stat-bg);
            font-weight: bold;
            white-space: nowrap;
        }

        .users-table tr:hover {
            background-color: var(--hover-bg);
        }

        .admin-badge {
            background: var(--admin-badge);
            color: var(--admin-text);
            padding: 3px 8px;
            border-radius: 5px;
            font-size: 0.8em;
            font-weight: 600;
            white-space: nowrap;
        }

        .user-badge {
            background: var(--success);
            color: white;
            padding: 3px 8px;
            border-radius: 5px;
            font-size: 0.8em;
            white-space: nowrap;
        }

        .btn-small {
            padding: 5px 10px;
            font-size: 0.85em;
            margin: 2px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s;
            white-space: nowrap;
        }

        .btn-small:hover {
            transform: translateY(-2px);
        }

        .btn-danger {
            background: var(--accent);
            color: white;
        }

        .btn-success {
            background: var(--success);
            color: white;
        }

        .btn-warning {
            background: var(--warning);
            color: black;
        }

        .btn-info {
            background: var(--secondary);
            color: white;
        }

        .search-box {
            margin-bottom: 20px;
            padding: 10px;
            width: 100%;
            max-width: 300px;
            border: 2px solid var(--border-color);
            border-radius: 5px;
            font-size: 16px;
            background: var(--input-bg);
            color: var(--text-color);
        }

        .pagination {
            margin-top: 20px;
            display: flex;
            justify-content: center;
            gap: 10px;
            flex-wrap: wrap;
        }

        .pagination button {
            padding: 5px 10px;
            border: 1px solid var(--border-color);
            background: var(--card-bg);
            color: var(--text-color);
            cursor: pointer;
            border-radius: 5px;
            min-width: 35px;
        }

        .pagination button:hover {
            background: var(--hover-bg);
        }

        .pagination button.active {
            background: var(--secondary);
            color: white;
            border-color: var(--secondary);
        }

        /* Мобилна версия */
        @media (max-width: 768px) {
            body {
                overflow-y: auto;
            }
            
            .container {
                flex-direction: column;
                overflow-y: auto;
            }
            
            .sidebar {
                width: 100%;
                height: auto;
                min-height: 50px;
                flex-direction: row;
                position: relative;
                z-index: 100;
                padding: 0;
            }
            
            .sidebar-header {
                padding: 5px 8px;
                border-bottom: none;
                border-right: 1px solid rgba(255, 255, 255, 0.1);
                display: flex;
                align-items: center;
                min-width: 70px;
            }
            
            .sidebar-header h2 {
                font-size: 1rem;
                margin: 0;
            }
            
            .sidebar-header .logo-icon {
                width: 30px;
                height: 30px;
                margin-right: 4px;
            }
            
            .sidebar-header img.logo-icon {
                width: 30px;
                height: 30px;
            }
            
            .nav-menu {
                display: flex;
                padding: 0 2px;
                flex: 1;
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
                scrollbar-width: none;
                gap: 5px;
                justify-content: flex-start;
                align-items: center;
                flex-wrap: nowrap;
            }
            
            .nav-menu::-webkit-scrollbar {
                display: none;
            }
            
            .nav-item {
                flex: 0 0 auto;
                display: flex;
                justify-content: center;
                align-items: center;
                padding: 8px 5px;
                border-left: none;
                border-bottom: 3px solid transparent;
                min-width: 35px;
                margin: 0 1px;
            }
            
            .nav-item:hover, .nav-item.active {
                border-left-color: transparent;
                border-bottom-color: var(--secondary);
            }
            
            .nav-item span {
                display: none !important;
            }
            
            .nav-item i {
                margin-right: 0;
                font-size: 1.3rem;
                color: var(--secondary);
            }
            
            .user-info {
                display: none;
            }
            
            .header {
                padding: 8px 10px;
                flex-direction: column;
                gap: 5px;
            }
            
            .header h1 {
                font-size: 1.1rem;
                text-align: center;
                margin: 0;
            }
            
            .search-bar {
                width: 100%;
                max-width: 100%;
            }
            
            .search-bar input {
                padding: 6px 10px;
                font-size: 0.9rem;
            }
            
            .content-area {
                padding: 8px;
                height: calc(100vh - 110px);
                overflow-y: auto;
            }
            
            .map-container {
                height: 55vh;
                position: relative;
            }
            
            .map-title {
                top: 5px;
                left: 5px;
                right: 5px;
                min-width: auto;
                padding: 8px 10px;
            }
            
            .map-title h2 {
                font-size: 1rem;
            }
            
            .map-title p {
                font-size: 0.75rem;
            }
            
            .status-panel {
                position: relative;
                top: auto;
                right: auto;
                left: auto;
                margin: 10px 0 5px;
                width: 100%;
                min-width: auto;
                pointer-events: auto;
                padding: 10px;
            }
            
            .info-footer {
                position: relative;
                bottom: auto;
                left: auto;
                right: auto;
                flex-direction: column;
                gap: 5px;
                margin: 5px 0;
                pointer-events: auto;
            }
            
            .parking-stats {
                width: 100%;
                justify-content: space-around;
                padding: 8px 10px;
                gap: 10px;
            }
            
            .stat-item {
                font-size: 0.85rem;
            }
            
            .controls {
                width: 100%;
            }
            
            .controls button {
                width: 100%;
                justify-content: center;
                padding: 8px 15px;
            }
            
            .legend {
                position: relative;
                bottom: auto;
                right: auto;
                margin: 5px 0;
                width: 100%;
            }
            
            .profile-header {
                flex-direction: column;
                text-align: center;
                padding: 15px 10px;
                gap: 10px;
            }
            
            .profile-avatar-large {
                width: 60px;
                height: 60px;
                font-size: 2rem;
            }
            
            .profile-header-info h2 {
                font-size: 1.3rem;
            }
            
            .details-grid {
                grid-template-columns: 1fr;
                gap: 8px;
            }
            
            .profile-details {
                padding: 10px;
            }
            
            .detail-item .detail-value {
                font-size: 0.95rem;
                padding: 6px 10px;
            }
            
            .edit-profile-btn {
                padding: 8px 15px;
                font-size: 0.9rem;
                width: 100%;
                justify-content: center;
            }
            
            .auth-container,
            .register-container,
            .profile-container,
            .admin-container {
                margin: 5px;
                width: calc(100% - 10px);
                overflow-y: auto;
            }
            
            .auth-header,
            .register-header {
                padding: 15px 10px;
            }
            
            .auth-header i,
            .register-header i {
                font-size: 2rem;
                width: 50px;
                height: 50px;
                line-height: 50px;
            }
            
            .auth-header h2,
            .register-header h2 {
                font-size: 1.3rem;
            }
            
            .auth-form,
            .register-form {
                padding: 10px;
            }
            
            .auth-form .form-group,
            .register-form .form-group {
                margin-bottom: 10px;
            }
            
            .auth-form .form-group input,
            .register-form .form-group input {
                padding: 8px 10px;
                font-size: 0.9rem;
            }
            
            .register-form .form-row {
                flex-direction: column;
                gap: 10px;
                margin-bottom: 0;
            }
            
            .auth-btn {
                padding: 10px;
                font-size: 1rem;
            }
            
            .auth-links {
                margin-top: 10px;
                font-size: 0.9rem;
            }
            
            .social-login {
                gap: 5px;
            }
            
            .social-btn {
                width: 40px;
                height: 40px;
                font-size: 1.1rem;
            }
            
            .terms-checkbox {
                margin: 10px 0;
                align-items: flex-start;
            }
            
            .terms-checkbox input {
                margin-top: 2px;
                width: 16px;
                height: 16px;
            }
            
            .terms-checkbox label {
                font-size: 0.85rem;
                flex: 1;
                line-height: 1.3;
            }
            
            .settings-list {
                margin-top: 5px;
            }
            
            .setting-item {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
                padding: 12px;
            }
            
            .setting-info {
                width: 100%;
            }
            
            .setting-info h4 {
                font-size: 0.95rem;
            }
            
            .setting-info p {
                font-size: 0.8rem;
            }
            
            .toggle-switch {
                align-self: flex-start;
            }
            
            select {
                width: 100%;
                min-width: auto;
                padding: 8px 10px;
            }
            
            .favorites-list {
                grid-template-columns: 1fr;
                gap: 10px;
                margin-top: 10px;
            }
            
            .favorite-card {
                padding: 12px;
            }
            
            .favorite-name {
                font-size: 1rem;
            }
            
            .favorite-status {
                font-size: 0.7rem;
                padding: 3px 8px;
            }
            
            .contact-modal {
                width: calc(100% - 20px);
                right: 10px;
                left: 10px;
                bottom: 70px;
                max-width: 400px;
                margin: 0 auto;
            }
            
            .contact-bubble {
                bottom: 15px;
                right: 15px;
                width: 50px;
                height: 50px;
                font-size: 1.5rem;
            }
            
            .modal-header {
                padding: 12px;
            }
            
            .modal-header h3 {
                font-size: 1rem;
            }
            
            .modal-body {
                padding: 12px;
            }
            
            .contact-form textarea {
                padding: 8px;
                font-size: 0.9rem;
                min-height: 80px;
            }
            
            .install-banner {
                bottom: 70px;
                left: 5px;
                right: 5px;
                max-width: none;
                padding: 10px;
            }
            
            .install-banner-content {
                gap: 8px;
            }
            
            .install-banner-icon {
                width: 35px;
                height: 35px;
                font-size: 1.3rem;
            }
            
            .install-banner-text h4 {
                font-size: 0.9rem;
            }
            
            .install-banner-text p {
                font-size: 0.75rem;
            }
            
            .install-banner-btn {
                padding: 5px 10px;
                font-size: 0.8rem;
            }
            
            .admin-stats {
                grid-template-columns: repeat(2, 1fr);
                gap: 10px;
            }
            
            .admin-stat-card {
                padding: 12px;
            }
            
            .admin-stat-number {
                font-size: 1.8rem;
            }
            
            .admin-stat-label {
                font-size: 0.8rem;
            }
            
            .users-table {
                padding: 10px;
                overflow-x: auto;
            }
            
            .users-table table {
                min-width: 800px;
                font-size: 0.8rem;
            }
            
            .users-table th, .users-table td {
                padding: 8px 5px;
            }
            
            .btn-small {
                padding: 4px 6px;
                font-size: 0.75rem;
                margin: 2px 0;
                display: inline-block;
            }
            
            .search-box {
                max-width: 100%;
            }

            .modal-content {
                margin: 10px;
                padding: 20px;
            }
            
            .favorite-actions {
                flex-direction: column;
            }
        }

        @media (max-width: 380px) {
            .sidebar-header {
                padding: 5px 5px;
                min-width: 60px;
            }
            
            .sidebar-header h2 {
                font-size: 0.85rem;
            }
            
            .sidebar-header .logo-icon {
                width: 25px;
                height: 25px;
            }
            
            .nav-menu {
                gap: 3px;
                padding: 0 1px;
            }
            
            .nav-item {
                padding: 6px 3px;
                min-width: 32px;
            }
            
            .nav-item i {
                font-size: 1.1rem;
            }
            
            .map-title h2 {
                font-size: 0.9rem;
            }
            
            .map-title p {
                font-size: 0.7rem;
            }
            
            .status-panel {
                padding: 8px;
            }
            
            .status-item {
                padding: 4px 6px;
                font-size: 0.8rem;
            }
            
            .spot-badge {
                width: 22px;
                height: 22px;
                font-size: 0.75rem;
            }
            
            .parking-stats {
                padding: 6px 8px;
                gap: 8px;
            }
            
            .stat-item {
                font-size: 0.75rem;
            }
            
            .stat-item i {
                font-size: 0.8rem;
            }
            
            .controls button {
                padding: 8px 12px;
                font-size: 0.85rem;
            }
            
            .legend-item {
                font-size: 0.75rem;
            }
            
            .admin-stats {
                grid-template-columns: 1fr;
            }
        }

        [data-lang="bg"] .lang-en {
            display: none !important;
        }

        [data-lang="en"] .lang-bg {
            display: none !important;
        }

        body.offline::after {
            content: "📴 Офлайн режим";
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: var(--warning);
            color: #000;
            text-align: center;
            padding: 5px;
            font-size: 0.9rem;
            z-index: 10000;
            font-weight: 600;
        }

        body.offline .lang-en::after {
            content: "📴 Offline mode";
        }
    </style>
</head>
<body data-lang="bg">
    <div class="container">
        <!-- Сайдбар с навигация -->
        <div class="sidebar">
            <div class="sidebar-header">
                <h2>
                    <img src="logo.svg" alt="Parkly" class="logo-icon" onerror="this.style.display='none'; this.nextElementSibling.style.display='inline-block';">
                    <i class="fas fa-parking logo-icon" style="display: none;"></i>
                    <span>Parkly</span>
                </h2>
            </div>
            
            <div class="nav-menu">
                <div class="nav-item active" data-page="map">
                    <i class="fas fa-map"></i>
                    <span class="lang-bg">Карта</span>
                    <span class="lang-en">Map</span>
                </div>
                <div class="nav-item" data-page="favorites">
                    <i class="fas fa-star"></i>
                    <span class="lang-bg">Любими</span>
                    <span class="lang-en">Favorites</span>
                </div>
                <div class="nav-item" data-page="profile">
                    <i class="fas fa-user-circle"></i>
                    <span class="lang-bg">Профил</span>
                    <span class="lang-en">Profile</span>
                </div>
                <div class="nav-item" id="admin-nav-item" data-page="admin" style="display: none;">
                    <i class="fas fa-users-cog"></i>
                    <span class="lang-bg">Админ</span>
                    <span class="lang-en">Admin</span>
                </div>
                <div class="nav-item" id="login-nav-item" data-page="login">
                    <i class="fas fa-sign-in-alt"></i>
                    <span class="lang-bg">Вход</span>
                    <span class="lang-en">Login</span>
                </div>
                <div class="nav-item" id="register-nav-item" data-page="register">
                    <i class="fas fa-user-plus"></i>
                    <span class="lang-bg">Регистрация</span>
                    <span class="lang-en">Register</span>
                </div>
                <div class="nav-item" id="logout-nav-item" data-page="logout" style="display: none;">
                    <i class="fas fa-sign-out-alt"></i>
                    <span class="lang-bg">Изход</span>
                    <span class="lang-en">Logout</span>
                </div>
                <div class="nav-item" data-page="settings">
                    <i class="fas fa-cog"></i>
                    <span class="lang-bg">Настройки</span>
                    <span class="lang-en">Settings</span>
                </div>
            </div>
            
            <div class="user-info" id="userInfo">
                <div class="user-avatar" id="userAvatar"><i class="fas fa-user"></i></div>
                <div>
                    <div class="user-name lang-bg" id="userName">Гост</div>
                    <div class="user-name lang-en" id="userNameEn">Guest</div>
                    <div class="user-status lang-bg" id="userStatus"></div>
                    <div class="user-status lang-en" id="userStatusEn"></div>
                </div>
            </div>
        </div>
        
        <!-- Основно съдържание -->
        <div class="main-content">
            <div class="header">
                <h1 id="page-title" class="lang-bg">Карта</h1>
                <h1 id="page-title" class="lang-en">Map</h1>
                <div class="search-bar">
                    <input type="text" id="search-input" class="lang-bg" placeholder="Търсене...">
                    <input type="text" id="search-input" class="lang-en" placeholder="Search...">
                    <button id="search-btn"><i class="fas fa-search"></i></button>
                </div>
            </div>
            
            <div class="content-area">
                <!-- Карта на паркингите -->
                <div id="map-page" class="page active">
                    <div class="map-container">
                        <div id="map"></div>
                        
                        <!-- Хедър на картата -->
                        <div class="map-title">
                            <h2>
                                <i class="fas fa-parking"></i>
                                <span class="lang-bg">ул. "Епископ Софроний"</span>
                                <span class="lang-en">"Ep. Sofroniy" Street</span>
                            </h2>
                            <p>
                                <i class="fas fa-map-marker-alt"></i>
                                <span class="lang-bg">Габрово • 3 места (1 инвалиди)</span>
                                <span class="lang-en">Gabrovo • 3 spots (1 disabled)</span>
                            </p>
                        </div>
                        
                        <!-- Статус панел -->
                        <div class="status-panel" id="statusPanel">
                            <div class="status-title">
                                <i class="fas fa-clipboard-list"></i>
                                <span class="lang-bg">Текущ статус</span>
                                <span class="lang-en">Current Status</span>
                            </div>
                            
                            <div class="status-item" id="spot1-item">
                                <div class="spot-number">
                                    <span class="spot-badge disabled-badge">
                                        <i class="fas fa-wheelchair"></i>
                                    </span>
                                    <span class="lang-bg">Място 1</span>
                                    <span class="lang-en">Spot 1</span>
                                </div>
                                <div>
                                    <span id="status1" class="status-value status-pending">
                                        <i class="fas fa-spinner fa-spin"></i>
                                        <span class="lang-bg">Зареждане...</span>
                                        <span class="lang-en">Loading...</span>
                                    </span>
                                </div>
                            </div>
                            
                            <div class="status-item" id="spot2-item">
                                <div class="spot-number">
                                    <span class="spot-badge">2</span>
                                    <span class="lang-bg">Място 2</span>
                                    <span class="lang-en">Spot 2</span>
                                </div>
                                <div>
                                    <span id="status2" class="status-value status-pending">
                                        <i class="fas fa-spinner fa-spin"></i>
                                        <span class="lang-bg">Зареждане...</span>
                                        <span class="lang-en">Loading...</span>
                                    </span>
                                </div>
                            </div>
                            
                            <div class="status-item">
                                <div class="spot-number">
                                    <span class="spot-badge">3</span>
                                    <span class="lang-bg">Място 3</span>
                                    <span class="lang-en">Spot 3</span>
                                </div>
                                <div>
                                    <span id="status3" class="status-value status-empty">
                                        <i class="fas fa-check-circle"></i>
                                        <span class="lang-bg">СВОБОДНО</span>
                                        <span class="lang-en">FREE</span>
                                    </span>
                                </div>
                            </div>
                            
                            <!-- Показва се само за нелогнати -->
                            <div class="login-prompt" id="loginPrompt">
                                <i class="fas fa-lock"></i> 
                                <span class="lang-bg"><a href="#" onclick="document.querySelector('[data-page=login]').click(); return false;">Влезте</a> за статус</span>
                                <span class="lang-en"><a href="#" onclick="document.querySelector('[data-page=login]').click(); return false;">Login</a> for status</span>
                            </div>
                            
                            <div class="last-update">
                                <i class="far fa-clock"></i>
                                <span id="lastUpdate"><span class="lang-bg">--:--:--</span><span class="lang-en">--:--:--</span></span>
                            </div>
                        </div>
                        
                        <!-- Долен панел -->
                        <div class="info-footer">
                            <div class="parking-stats">
                                <div class="stat-item">
                                    <i class="fas fa-parking"></i>
                                    <span class="label lang-bg">Общо:</span>
                                    <span class="label lang-en">Total:</span>
                                    <span class="value">3</span>
                                </div>
                                <div class="stat-item">
                                    <i class="fas fa-check-circle icon-success"></i>
                                    <span class="label lang-bg">Свободни:</span>
                                    <span class="label lang-en">Free:</span>
                                    <span class="value" id="freeSpots">1</span>
                                </div>
                            </div>
                            
                            <div class="controls">
                                <button onclick="manualRefresh()">
                                    <i class="fas fa-sync-alt"></i>
                                    <span class="lang-bg">Обнови</span>
                                    <span class="lang-en">Refresh</span>
                                </button>
                            </div>
                        </div>
                        
                        <!-- Легенда -->
                        <div class="legend">
                            <div class="legend-item">
                                <div class="legend-color blue"></div>
                                <span class="lang-bg">Инвалиди</span>
                                <span class="lang-en">Disabled</span>
                            </div>
                            <div class="legend-item">
                                <div class="legend-color green"></div>
                                <span class="lang-bg">Свободно</span>
                                <span class="lang-en">Free</span>
                            </div>
                            <div class="legend-item">
                                <div class="legend-color red"></div>
                                <span class="lang-bg">Заето</span>
                                <span class="lang-en">Occupied</span>
                            </div>
                            <div class="legend-item">
                                <div class="legend-color yellow"></div>
                                <span class="lang-bg">Любимо</span>
                                <span class="lang-en">Favorite</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Любими места -->
                <div id="favorites-page" class="page">
                    <h2 class="form-title lang-bg">⭐ Любими паркинги</h2>
                    <h2 class="form-title lang-en">⭐ Favorite Parking Lots</h2>
                    
                    <!-- Login prompt за любими -->
                    <div id="favorites-login-prompt" style="display: none; text-align: center; padding: 50px 20px;">
                        <i class="fas fa-lock" style="font-size: 3rem; color: var(--text-secondary); margin-bottom: 20px;"></i>
                        <p class="lang-bg">Моля, <a href="#" onclick="document.querySelector('[data-page=login]').click(); return false;">влезте</a> в профила си, за да видите любимите места.</p>
                        <p class="lang-en">Please <a href="#" onclick="document.querySelector('[data-page=login]').click(); return false;">login</a> to see your favorite spots.</p>
                    </div>
                    
                    <div id="favorites-list-container">
                        <div class="favorites-list" id="favorites-list"></div>
                    </div>
                </div>
                
                <!-- Моят профил -->
                <div id="profile-page" class="page">
                    <div class="profile-container">
                        <div class="profile-header">
                            <div class="profile-avatar-large">
                                <i class="fas fa-user"></i>
                            </div>
                            <div class="profile-header-info">
                                <h2 id="profile-name" class="lang-bg"></h2>
                                <h2 id="profile-name-en" class="lang-en"></h2>
                                <p><i class="fas fa-envelope"></i> <span id="profile-email"></span></p>
                                <p><i class="fas fa-phone"></i> <span id="profile-phone">-</span></p>
                                <p id="profile-admin-badge" style="display: none; background: var(--admin-badge); color: var(--admin-text); padding: 5px 10px; border-radius: 20px; margin-top: 5px;">
                                    <i class="fas fa-crown"></i> <span class="lang-bg">Администратор</span><span class="lang-en">Administrator</span>
                                </p>
                            </div>
                        </div>
                        
                        <div class="profile-details">
                            <h3><i class="fas fa-info-circle"></i> <span class="lang-bg">Лична информация</span><span class="lang-en">Personal Info</span></h3>
                            <div class="details-grid">
                                <div class="detail-item">
                                    <label class="lang-bg">Име и фамилия</label>
                                    <label class="lang-en">Full name</label>
                                    <div class="detail-value" id="profile-fullname"></div>
                                </div>
                                <div class="detail-item">
                                    <label>Email</label>
                                    <div class="detail-value" id="profile-email-detail"></div>
                                </div>
                                <div class="detail-item">
                                    <label class="lang-bg">Телефон</label>
                                    <label class="lang-en">Phone</label>
                                    <div class="detail-value" id="profile-phone-detail">-</div>
                                </div>
                                <div class="detail-item">
                                    <label class="lang-bg">Роля</label>
                                    <label class="lang-en">Role</label>
                                    <div class="detail-value" id="profile-role">Потребител</div>
                                </div>
                                <div class="detail-item">
                                    <label class="lang-bg">Регистрация</label>
                                    <label class="lang-en">Registered</label>
                                    <div class="detail-value" id="profile-created"></div>
                                </div>
                                <div class="detail-item">
                                    <label class="lang-bg">Последно влизане</label>
                                    <label class="lang-en">Last login</label>
                                    <div class="detail-value" id="profile-lastlogin"></div>
                                </div>
                            </div>
                            
                            <button class="edit-profile-btn" id="editProfileBtn">
                                <i class="fas fa-edit"></i>
                                <span class="lang-bg">Редактирай</span>
                                <span class="lang-en">Edit</span>
                            </button>
                            
                            <button class="edit-profile-btn" id="logoutProfileBtn" style="background: var(--accent); margin-top: 10px;">
                                <i class="fas fa-sign-out-alt"></i>
                                <span class="lang-bg">Изход</span>
                                <span class="lang-en">Logout</span>
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Модален прозорец за редактиране на профил -->
                <div class="modal-overlay" id="editProfileModal">
                    <div class="modal-content edit-modal-content">
                        <h3><i class="fas fa-edit"></i> <span class="lang-bg">Редактирай профил</span><span class="lang-en">Edit Profile</span></h3>
                        
                        <div class="form-group">
                            <label class="lang-bg">Име</label>
                            <label class="lang-en">First Name</label>
                            <input type="text" id="edit-firstname">
                        </div>
                        
                        <div class="form-group">
                            <label class="lang-bg">Фамилия</label>
                            <label class="lang-en">Last Name</label>
                            <input type="text" id="edit-lastname">
                        </div>
                        
                        <div class="form-group">
                            <label class="lang-bg">Телефон</label>
                            <label class="lang-en">Phone</label>
                            <input type="tel" id="edit-phone">
                        </div>
                        
                        <div class="edit-modal-actions">
                            <button class="save-btn" onclick="saveProfileChanges()"><span class="lang-bg">Запази</span><span class="lang-en">Save</span></button>
                            <button class="cancel-btn" onclick="closeEditModal()"><span class="lang-bg">Отказ</span><span class="lang-en">Cancel</span></button>
                        </div>
                    </div>
                </div>
                
                <!-- Модален прозорец за детайли на потребител (админ) -->
                <div class="modal-overlay" id="userDetailsModal">
                    <div class="modal-content">
                        <h3><i class="fas fa-user-circle"></i> <span class="lang-bg">Детайли за потребител</span><span class="lang-en">User Details</span></h3>
                        
                        <div id="userDetailsContent"></div>
                        
                        <div class="modal-actions">
                            <button class="close-btn" onclick="closeUserDetailsModal()"><span class="lang-bg">Затвори</span><span class="lang-en">Close</span></button>
                        </div>
                    </div>
                </div>
                
                <!-- Админ панел -->
                <div id="admin-page" class="page">
                    <div class="admin-container">
                        <h2 class="lang-bg" style="margin-bottom: 20px;">👑 Администраторско табло</h2>
                        <h2 class="lang-en" style="margin-bottom: 20px;">👑 Admin Dashboard</h2>
                        
                        <div class="admin-stats">
                            <div class="admin-stat-card">
                                <div class="admin-stat-number" id="adminTotalUsers">0</div>
                                <div class="admin-stat-label lang-bg">Общо потребители</div>
                                <div class="admin-stat-label lang-en">Total Users</div>
                            </div>
                            <div class="admin-stat-card">
                                <div class="admin-stat-number" id="adminVerifiedUsers">0</div>
                                <div class="admin-stat-label lang-bg">Потвърдени</div>
                                <div class="admin-stat-label lang-en">Verified</div>
                            </div>
                            <div class="admin-stat-card">
                                <div class="admin-stat-number" id="adminGoogleUsers">0</div>
                                <div class="admin-stat-label lang-bg">Google</div>
                                <div class="admin-stat-label lang-en">Google</div>
                            </div>
                            <div class="admin-stat-card">
                                <div class="admin-stat-number" id="adminEmailUsers">0</div>
                                <div class="admin-stat-label lang-bg">Имейл</div>
                                <div class="admin-stat-label lang-en">Email</div>
                            </div>
                            <div class="admin-stat-card">
                                <div class="admin-stat-number" id="adminAdminUsers">0</div>
                                <div class="admin-stat-label lang-bg">Администратори</div>
                                <div class="admin-stat-label lang-en">Admins</div>
                            </div>
                        </div>
                        
                        <div class="users-table">
                            <h2><i class="fas fa-users"></i> <span class="lang-bg">Управление на потребители</span><span class="lang-en">User Management</span></h2>
                            
                            <input type="text" class="search-box" id="adminSearchInput" placeholder="🔍 Търси по име или имейл...">
                            
                            <table>
                                <thead>
                                    <tr>
                                        <th class="lang-bg">Име</th>
                                        <th class="lang-bg">Фамилия</th>
                                        <th class="lang-bg">Имейл</th>
                                        <th class="lang-bg">Роля</th>
                                        <th class="lang-bg">Потв.</th>
                                        <th class="lang-bg">Провайдър</th>
                                        <th class="lang-bg">Регистрация</th>
                                        <th class="lang-bg">Последен вход</th>
                                        <th class="lang-bg">Действия</th>
                                        
                                        <th class="lang-en">First</th>
                                        <th class="lang-en">Last</th>
                                        <th class="lang-en">Email</th>
                                        <th class="lang-en">Role</th>
                                        <th class="lang-en">Verif.</th>
                                        <th class="lang-en">Provider</th>
                                        <th class="lang-en">Reg.</th>
                                        <th class="lang-en">Last Login</th>
                                        <th class="lang-en">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="adminUsersTableBody">
                                    <tr>
                                        <td colspan="9" style="text-align: center;">Зареждане...</td>
                                    </tr>
                                </tbody>
                            </table>
                            
                            <div class="pagination" id="adminPagination"></div>
                        </div>
                    </div>
                </div>
                
                <!-- Вход -->
                <div id="login-page" class="page">
                    <div class="auth-container">
                        <div class="auth-header">
                            <i class="fas fa-sign-in-alt"></i>
                            <h2 class="lang-bg">Добре дошли!</h2>
                            <h2 class="lang-en">Welcome!</h2>
                            <p class="lang-bg">Влезте в профила си</p>
                            <p class="lang-en">Sign in</p>
                        </div>
                        
                        <div class="auth-form">
                            <form id="login-form">
                                <div class="form-group">
                                    <label for="login-email">Email</label>
                                    <input type="email" id="login-email" placeholder="your@email.com" required>
                                </div>
                                
                                <div class="form-group">
                                    <label for="login-password" class="lang-bg">Парола</label>
                                    <label for="login-password" class="lang-en">Password</label>
                                    <input type="password" id="login-password" placeholder="••••••••" required>
                                </div>
                                
                                <button type="submit" class="auth-btn">
                                    <i class="fas fa-sign-in-alt"></i>
                                    <span class="lang-bg">Вход</span>
                                    <span class="lang-en">Login</span>
                                </button>
                                
                                <div class="auth-links">
                                    <a href="#" id="forgotPasswordLink" class="lang-bg">Забравена парола?</a>
                                    <a href="#" id="forgotPasswordLinkEn" class="lang-en">Forgot password?</a>
                                </div>
                                
                                <div class="auth-divider">
                                    <span class="lang-bg">или</span>
                                    <span class="lang-en">or</span>
                                </div>
                                
                                <div class="social-login">
                                    <button type="button" class="social-btn" id="googleLoginBtn"><i class="fab fa-google"></i></button>
                                </div>
                                
                                <div class="auth-links auth-links-margin">
                                    <span class="lang-bg">Нямате профил?</span>
                                    <span class="lang-en">No account?</span>
                                    <a href="#" onclick="document.querySelector('[data-page=register]').click(); return false;" class="lang-bg">Регистрация</a>
                                    <a href="#" onclick="document.querySelector('[data-page=register]').click(); return false;" class="lang-en">Register</a>
                                </div>
                                
                                <div id="login-error" style="color: var(--accent); text-align: center; margin-top: 10px; display: none;"></div>
                                <div id="login-success" style="color: var(--success); text-align: center; margin-top: 10px; display: none;"></div>
                            </form>
                        </div>
                    </div>
                </div>
                
                <!-- Регистрация -->
                <div id="register-page" class="page">
                    <div class="register-container">
                        <div class="register-header">
                            <i class="fas fa-user-plus"></i>
                            <h2 class="lang-bg">Създайте профил</h2>
                            <h2 class="lang-en">Create Account</h2>
                            <p class="lang-bg">Присъединете се</p>
                            <p class="lang-en">Join us</p>
                        </div>
                        
                        <div class="register-form">
                            <form id="register-form">
                                <div class="form-row">
                                    <div class="form-group">
                                        <label for="register-firstname" class="lang-bg">Име *</label>
                                        <label for="register-firstname" class="lang-en">First Name *</label>
                                        <input type="text" id="register-firstname" required>
                                    </div>
                                    <div class="form-group">
                                        <label for="register-lastname" class="lang-bg">Фамилия *</label>
                                        <label for="register-lastname" class="lang-en">Last Name *</label>
                                        <input type="text" id="register-lastname" required>
                                    </div>
                                </div>
                                
                                <div class="form-row">
                                    <div class="form-group">
                                        <label for="register-email">Email *</label>
                                        <input type="email" id="register-email" required>
                                    </div>
                                    <div class="form-group">
                                        <label for="register-phone" class="lang-bg">Телефон</label>
                                        <label for="register-phone" class="lang-en">Phone</label>
                                        <input type="tel" id="register-phone">
                                    </div>
                                </div>
                                
                                <div class="form-row">
                                    <div class="form-group">
                                        <label for="register-password" class="lang-bg">Парола *</label>
                                        <label for="register-password" class="lang-en">Password *</label>
                                        <input type="password" id="register-password" required>
                                    </div>
                                    <div class="form-group">
                                        <label for="register-confirm" class="lang-bg">Потвърдете *</label>
                                        <label for="register-confirm" class="lang-en">Confirm *</label>
                                        <input type="password" id="register-confirm" required>
                                    </div>
                                </div>
                                
                                <div class="terms-checkbox">
                                    <input type="checkbox" id="terms" required>
                                    <label for="terms" class="lang-bg">Съгласявам се с <a href="#">Общите условия</a></label>
                                    <label for="terms" class="lang-en">I agree to <a href="#">Terms</a></label>
                                </div>
                                
                                <button type="submit" class="auth-btn">
                                    <i class="fas fa-user-check"></i>
                                    <span class="lang-bg">Регистрация</span>
                                    <span class="lang-en">Register</span>
                                </button>
                                
                                <div class="auth-divider">
                                    <span class="lang-bg">или</span>
                                    <span class="lang-en">or</span>
                                </div>
                                
                                <div class="social-login">
                                    <button type="button" class="social-btn" id="googleRegisterBtn"><i class="fab fa-google"></i></button>
                                </div>
                                
                                <div class="auth-links auth-links-margin">
                                    <span class="lang-bg">Вече имате профил?</span>
                                    <span class="lang-en">Have account?</span>
                                    <a href="#" onclick="document.querySelector('[data-page=login]').click(); return false;" class="lang-bg">Вход</a>
                                    <a href="#" onclick="document.querySelector('[data-page=login]').click(); return false;" class="lang-en">Login</a>
                                </div>
                                
                                <div id="register-error" style="color: var(--accent); text-align: center; margin-top: 10px; display: none;"></div>
                                <div id="register-success" style="color: var(--success); text-align: center; margin-top: 10px; display: none;"></div>
                            </form>
                        </div>
                    </div>
                </div>
                
                <!-- Настройки -->
                <div id="settings-page" class="page">
                    <h2 class="form-title lang-bg">Настройки</h2>
                    <h2 class="form-title lang-en">Settings</h2>
                    <div class="settings-list">
                        <div class="setting-item">
                            <div class="setting-info">
                                <h4 class="lang-bg">Тъмна тема</h4>
                                <h4 class="lang-en">Dark theme</h4>
                                <p class="lang-bg">Превключване на темата</p>
                                <p class="lang-en">Switch theme</p>
                            </div>
                            <div class="toggle-switch">
                                <input type="checkbox" id="darkmode-toggle">
                                <label for="darkmode-toggle" class="slider"></label>
                            </div>
                        </div>
                        <div class="setting-item">
                            <div class="setting-info">
                                <h4 class="lang-bg">Език</h4>
                                <h4 class="lang-en">Language</h4>
                                <p class="lang-bg">Изберете език</p>
                                <p class="lang-en">Select language</p>
                            </div>
                            <select id="language-select">
                                <option value="bg" selected>Български</option>
                                <option value="en">English</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Банер за инсталиране на PWA -->
    <div class="install-banner" id="installBanner">
        <div class="install-banner-content">
            <div class="install-banner-icon">
                <i class="fas fa-parking"></i>
            </div>
            <div class="install-banner-text">
                <h4 class="lang-bg">Инсталирай Parkly</h4>
                <h4 class="lang-en">Install Parkly</h4>
                <p class="lang-bg">Добави на началния екран</p>
                <p class="lang-en">Add to home screen</p>
            </div>
        </div>
        <div class="install-banner-actions">
            <button class="install-banner-btn" id="installBtn"><span class="lang-bg">Инсталирай</span><span class="lang-en">Install</span></button>
            <button class="install-banner-close" id="closeInstallBanner">&times;</button>
        </div>
    </div>
    
    <!-- Балонче за контакти -->
    <div class="contact-bubble" id="contactBubble">
        <i class="fas fa-headset"></i>
    </div>
    
    <!-- Модален прозорец за контакти -->
    <div class="contact-modal" id="contactModal">
        <div class="modal-header">
            <h3><i class="fas fa-headset"></i> <span class="lang-bg">Контакти</span><span class="lang-en">Contact</span></h3>
            <button class="modal-close" id="closeModal">&times;</button>
        </div>
        <div class="modal-body">
            <form class="contact-form" id="contactForm">
                <textarea class="lang-bg" placeholder="Вашето съобщение..." required></textarea>
                <textarea class="lang-en" placeholder="Your message..." required></textarea>
                <button type="submit" class="btn btn-block">
                    <i class="fas fa-paper-plane"></i> <span class="lang-bg">Изпрати</span><span class="lang-en">Send</span>
                </button>
            </form>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
    
    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <script>
        // ===== Firebase конфигурация =====
        // Конфигурация за Authentication и Firestore (от registration-88c86)
        const firebaseConfig = {
            apiKey: "AIzaSyCtTNJsKJWnOVpRazP5Txz37ll_odEkEo8",
            authDomain: "registration-88c86.firebaseapp.com",
            projectId: "registration-88c86",
            storageBucket: "registration-88c86.firebasestorage.app",
            messagingSenderId: "344139226116",
            appId: "1:344139226116:web:4d1559eab47beab89a2951"
        };
        
        // Конфигурация за Realtime Database със сензорите (от ESP32)
        const databaseConfig = {
            databaseURL: "https://esp32-5d620-default-rtdb.firebaseio.com/"
        };
        
        // Инициализиране на Firebase за Authentication и Firestore
        const app = firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        
        // Инициализиране на второ приложение за Realtime Database
        const secondaryApp = firebase.initializeApp(databaseConfig, "secondary");
        const rtdb = secondaryApp.database();
        
        // ===== Глобални променливи =====
        let currentUser = null;
        let isAdmin = false;
        let spot1Status = "ЗАРЕЖДАНЕ";
        let spot2Status = "ЗАРЕЖДАНЕ";
        let spot1Distance = -1;
        let spot2Distance = -1;
        let lastUpdateTime = null;
        let map = null;
        let parkingPolygons = [];
        let allUsers = [];
        let filteredUsers = [];
        let currentAdminPage = 1;
        const usersPerPage = 10;
        let userFavorites = []; // Масив с любими места на потребителя
        
        // Данни за паркоместата
        const parkingSpotsData = [
            { id: "spot1", number: 1, name: "Място 1", nameEn: "Spot 1", type: "disabled", lat: 42.8768, lng: 25.3179 },
            { id: "spot2", number: 2, name: "Място 2", nameEn: "Spot 2", type: "regular", lat: 42.8768, lng: 25.3179 },
            { id: "spot3", number: 3, name: "Място 3", nameEn: "Spot 3", type: "regular", lat: 42.8768, lng: 25.3179 }
        ];
        
        // ===== PWA Инсталация =====
        let deferredPrompt;
        const installBanner = document.getElementById('installBanner');
        const installBtn = document.getElementById('installBtn');
        const closeInstallBanner = document.getElementById('closeInstallBanner');

        if (!localStorage.getItem('installBannerClosed')) {
            window.addEventListener('beforeinstallprompt', (e) => {
                e.preventDefault();
                deferredPrompt = e;
                installBanner.style.display = 'flex';
            });
        }

        installBtn.addEventListener('click', async () => {
            if (!deferredPrompt) return;
            deferredPrompt.prompt();
            const { outcome } = await deferredPrompt.userChoice;
            console.log(`Потребителски избор: ${outcome}`);
            deferredPrompt = null;
            installBanner.style.display = 'none';
        });

        closeInstallBanner.addEventListener('click', () => {
            installBanner.style.display = 'none';
            localStorage.setItem('installBannerClosed', 'true');
        });

        window.addEventListener('online', () => document.body.classList.remove('offline'));
        window.addEventListener('offline', () => document.body.classList.add('offline'));

        // ===== ФУНКЦИИ ЗА ПОКАЗВАНЕ НА СЪОБЩЕНИЯ =====
        function showError(elementId, message) {
            const element = document.getElementById(elementId);
            if (element) {
                element.innerHTML = message;
                element.style.display = 'block';
                setTimeout(() => element.style.display = 'none', 5000);
            }
        }

        function showSuccess(elementId, message) {
            const element = document.getElementById(elementId);
            if (element) {
                element.innerHTML = message;
                element.style.display = 'block';
                setTimeout(() => element.style.display = 'none', 5000);
            }
        }

        // ===== ПРОВЕРКА ЗА АДМИНИСТРАТОР =====
        async function isUserAdmin(userId) {
            try {
                const userDoc = await db.collection('users').doc(userId).get();
                const userData = userDoc.data();
                return userData?.isAdmin === true || userData?.role === 'admin';
            } catch (error) {
                console.error('Грешка при проверка за администратор:', error);
                return false;
            }
        }

        // ===== ФУНКЦИИ ЗА ЛЮБИМИ МЕСТА =====
        async function loadUserFavorites() {
            if (!currentUser) return;
            
            try {
                const userDoc = await db.collection('users').doc(currentUser.uid).get();
                if (userDoc.exists) {
                    const userData = userDoc.data();
                    userFavorites = userData.favorites || [];
                    console.log("Любими места заредени:", userFavorites);
                }
            } catch (error) {
                console.error('Грешка при зареждане на любими:', error);
            }
        }

        async function toggleFavorite(spotId) {
            if (!currentUser) {
                const currentLang = document.body.getAttribute('data-lang') || 'bg';
                alert(currentLang === 'bg' ? 'Моля, влезте в профила си, за да добавяте любими места.' : 'Please login to add favorites.');
                document.querySelector('[data-page=login]').click();
                return;
            }
            
            try {
                const userRef = db.collection('users').doc(currentUser.uid);
                const userDoc = await userRef.get();
                
                if (userDoc.exists) {
                    const userData = userDoc.data();
                    let favorites = userData.favorites || [];
                    
                    if (favorites.includes(spotId)) {
                        // Премахване от любими
                        favorites = favorites.filter(id => id !== spotId);
                        showSuccess('login-success', 'Премахнато от любими!');
                    } else {
                        // Добавяне към любими
                        favorites.push(spotId);
                        showSuccess('login-success', 'Добавено към любими!');
                    }
                    
                    await userRef.update({ favorites: favorites });
                    userFavorites = favorites;
                    
                    // Актуализираме бутоните на картата
                    updateFavoriteButtons();
                    
                    // Актуализираме списъка с любими, ако страницата е активна
                    if (document.getElementById('favorites-page').classList.contains('active')) {
                        displayFavorites();
                    }
                    
                    // Актуализираме попъпите на картата
                    if (map && parkingPolygons.length > 0) {
                        parkingPolygons.forEach(polygon => map.removeLayer(polygon));
                        parkingPolygons = [];
                        createParkingSpots();
                    }
                }
            } catch (error) {
                console.error('Грешка при промяна на любими:', error);
                alert('Грешка: ' + error.message);
            }
        }

        function isFavorite(spotId) {
            return userFavorites && userFavorites.includes(spotId);
        }

        function updateFavoriteButtons() {
            // Актуализираме всички бутони за любими на картата
            document.querySelectorAll('.favorite-btn').forEach(btn => {
                const spotId = btn.getAttribute('data-spot-id');
                if (isFavorite(spotId)) {
                    btn.innerHTML = '<i class="fas fa-star"></i> Премахни';
                    btn.classList.add('btn-warning');
                    btn.classList.remove('btn-favorite');
                } else {
                    btn.innerHTML = '<i class="far fa-star"></i> Любимо';
                    btn.classList.add('btn-favorite');
                    btn.classList.remove('btn-warning');
                }
            });
        }

        function navigateToSpot(lat, lng, spotName) {
            const currentLang = document.body.getAttribute('data-lang') || 'bg';
            
            // Получаване на текущото место на потребителя
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    function(position) {
                        const userLat = position.coords.latitude;
                        const userLng = position.coords.longitude;
                        
                        // Проверка дали устройството е мобилно
                        const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
                        
                        if (isMobile) {
                            // Отваряне в Google Maps приложение на мобилно с маршрут
                            const url = `https://www.google.com/maps/dir/?api=1&origin=${userLat},${userLng}&destination=${lat},${lng}&travelmode=driving`;
                            window.open(url, '_blank');
                        } else {
                            // Отваряне в Google Maps в нов прозорец на десктоп с маршрут
                            const url = `https://www.google.com/maps/dir/?api=1&origin=${userLat},${userLng}&destination=${lat},${lng}&travelmode=driving`;
                            window.open(url, '_blank');
                        }
                        
                        console.log(`Навигация от (${userLat}, ${userLng}) до: ${spotName} (${lat}, ${lng})`);
                    },
                    function(error) {
                        // Грешка при получаването на местоположението - отваряме без маршрут
                        console.warn(`Грешка при получаването на местоположението: ${error.message}`);
                        const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
                        
                        if (isMobile) {
                            const url = `https://www.google.com/maps/dir/?api=1&destination=${lat},${lng}&travelmode=driving`;
                            window.open(url, '_blank');
                        } else {
                            const url = `https://www.google.com/maps/dir/?api=1&destination=${lat},${lng}&travelmode=driving`;
                            window.open(url, '_blank');
                        }
                        
                        console.log(`Навигация до: ${spotName} (${lat}, ${lng}) - без начална точка`);
                    }
                );
            } else {
                // Ако браузърът не поддържа Geolocation API
                console.warn('Geolocation не е поддържано в этот браузър');
                const url = `https://www.google.com/maps/dir/?api=1&destination=${lat},${lng}&travelmode=driving`;
                window.open(url, '_blank');
            }
        }

        // ===== ФУНКЦИИ ЗА ПОКАЗВАНЕ НА ЛЮБИМИ =====
        async function displayFavorites() {
            const favoritesList = document.getElementById('favorites-list');
            const loginPrompt = document.getElementById('favorites-login-prompt');
            const container = document.getElementById('favorites-list-container');
            
            if (!currentUser) {
                // Показваме съобщение за вход
                loginPrompt.style.display = 'block';
                container.style.display = 'none';
                return;
            }
            
            loginPrompt.style.display = 'none';
            container.style.display = 'block';
            
            if (!favoritesList) return;
            
            // Зареждаме любимите ако не са заредени
            if (userFavorites.length === 0) {
                await loadUserFavorites();
            }
            
            if (userFavorites.length === 0) {
                favoritesList.innerHTML = '<p style="text-align: center; padding: 50px;">Нямате добавени любими места.</p>';
                return;
            }
            
            const currentLang = document.body.getAttribute('data-lang') || 'bg';
            
            // Филтрираме само любимите места
            const favoriteSpots = parkingSpotsData.filter(spot => userFavorites.includes(spot.id));
            
            favoritesList.innerHTML = favoriteSpots.map(spot => {
                const spotStatus = spot.id === 'spot1' ? spot1Status : 
                                   spot.id === 'spot2' ? spot2Status : 'СВОБОДНО';
                
                const statusClass = spotStatus === 'СВОБОДНО' || spotStatus === 'ПРАЗНО' ? 'status-free' : 
                                   (spotStatus === 'ЗАЕТО' ? 'status-busy' : '');
                
                const statusText = spotStatus === 'ПРАЗНО' ? 'СВОБОДНО' : spotStatus;
                
                return `
                <div class="favorite-card">
                    <div class="favorite-header">
                        <div class="favorite-name lang-bg">${spot.name}</div>
                        <div class="favorite-name lang-en">${spot.nameEn}</div>
                        ${spot.type === 'disabled' ? '<i class="fas fa-wheelchair" style="color: var(--secondary);"></i>' : ''}
                    </div>
                    <p><i class="fas fa-map-marker-alt"></i> ул. "Епископ Софроний", Габрово</p>
                    <p><i class="fas fa-car"></i> 
                        <span class="lang-bg">Статус: </span>
                        <span class="lang-en">Status: </span>
                        <span class="${statusClass}" style="padding: 3px 8px; border-radius: 5px;">${statusText}</span>
                    </p>
                    ${spot.id === 'spot1' && currentUser ? `<p><i class="fas fa-ruler"></i> Разстояние: ${spot1Distance} см</p>` : ''}
                    ${spot.id === 'spot2' && currentUser ? `<p><i class="fas fa-ruler"></i> Разстояние: ${spot2Distance} см</p>` : ''}
                    
                    <div class="favorite-actions">
                        <button class="navigate-btn" onclick="navigateToSpot(${spot.lat}, ${spot.lng}, '${spot.name}')">
                            <i class="fas fa-directions"></i> <span class="lang-bg">Навигирай</span><span class="lang-en">Navigate</span>
                        </button>
                        <button class="remove-btn" onclick="toggleFavorite('${spot.id}')">
                            <i class="fas fa-trash"></i> <span class="lang-bg">Премахни</span><span class="lang-en">Remove</span>
                        </button>
                    </div>
                </div>
            `}).join('');
        }

        // ===== ФУНКЦИИ ЗА АКТУАЛИЗИРАНЕ НА UI СПОРЕД ПОТРЕБИТЕЛЯ =====
        function updateUIBasedOnAuth(user) {
            const loginNavItem = document.getElementById('login-nav-item');
            const registerNavItem = document.getElementById('register-nav-item');
            const logoutNavItem = document.getElementById('logout-nav-item');
            const adminNavItem = document.getElementById('admin-nav-item');
            const userName = document.getElementById('userName');
            const userNameEn = document.getElementById('userNameEn');
            const userStatus = document.getElementById('userStatus');
            const userStatusEn = document.getElementById('userStatusEn');
            const statusPanel = document.getElementById('statusPanel');
            const loginPrompt = document.getElementById('loginPrompt');
            
            if (user) {
                // Потребителят е логнат
                currentUser = user;
                
                loginNavItem.style.display = 'none';
                registerNavItem.style.display = 'none';
                logoutNavItem.style.display = 'flex';
                
                const displayName = user.displayName || user.email || 'Потребител';
                userName.textContent = displayName;
                userNameEn.textContent = displayName;
                
                // Премахваме restricted класа от статус панела
                statusPanel.classList.remove('restricted');
                loginPrompt.style.display = 'none';
                
                // Зареждаме любимите на потребителя
                loadUserFavorites().then(() => {
                    // Актуализираме бутоните на картата
                    updateFavoriteButtons();
                });
                
                // Зареждаме потребителските данни от Firestore
                loadUserProfile(user.uid);
                
                // Проверяваме дали е админ
                isUserAdmin(user.uid).then(admin => {
                    isAdmin = admin;
                    adminNavItem.style.display = admin ? 'flex' : 'none';
                    
                    // Актуализираме статуса в UI
                    userStatus.textContent = admin ? 'Администратор' : 'Потребител';
                    userStatusEn.textContent = admin ? 'Administrator' : 'User';
                    
                    if (admin) {
                        loadAllUsers();
                    }
                });
                
                // Актуализираме статусите
                updateSpotStatus(1, spot1Status, spot1Distance);
                updateSpotStatus(2, spot2Status, spot2Distance);
                if (map && parkingPolygons.length > 0) {
                    updateMapColors();
                }
            } else {
                // Потребителят не е логнат
                currentUser = null;
                isAdmin = false;
                userFavorites = [];
                
                loginNavItem.style.display = 'flex';
                registerNavItem.style.display = 'flex';
                logoutNavItem.style.display = 'none';
                adminNavItem.style.display = 'none';
                
                userName.textContent = 'Гост';
                userNameEn.textContent = 'Guest';
                userStatus.textContent = '';
                userStatusEn.textContent = '';
                
                // Добавяме restricted клас към статус панела
                statusPanel.classList.add('restricted');
                loginPrompt.style.display = 'block';
                
                // Изчистваме профил страницата
                clearProfilePage();
                
                // Показваме "ЗАРЕЖДАНЕ" за нелогнати
                updateSpotStatus(1, "ЗАРЕЖДАНЕ", -1);
                updateSpotStatus(2, "ЗАРЕЖДАНЕ", -1);
                
                // Нулираме админ данните
                allUsers = [];
                filteredUsers = [];
                
                // Актуализираме любимите
                if (document.getElementById('favorites-page').classList.contains('active')) {
                    displayFavorites();
                }
            }
        }

        function clearProfilePage() {
            document.getElementById('profile-name').textContent = '';
            document.getElementById('profile-name-en').textContent = '';
            document.getElementById('profile-email').textContent = '';
            document.getElementById('profile-fullname').textContent = '';
            document.getElementById('profile-email-detail').textContent = '';
            document.getElementById('profile-phone').textContent = '-';
            document.getElementById('profile-phone-detail').textContent = '-';
            document.getElementById('profile-role').textContent = 'Потребител';
            document.getElementById('profile-created').textContent = '';
            document.getElementById('profile-lastlogin').textContent = '';
            document.getElementById('profile-admin-badge').style.display = 'none';
        }

        async function loadUserProfile(userId) {
            try {
                const userDoc = await db.collection('users').doc(userId).get();
                if (userDoc.exists) {
                    const userData = userDoc.data();
                    
                    const fullName = userData.fullName || `${userData.firstName || ''} ${userData.lastName || ''}`.trim() || currentUser.displayName || 'Потребител';
                    
                    document.getElementById('profile-name').textContent = fullName;
                    document.getElementById('profile-name-en').textContent = fullName;
                    document.getElementById('profile-email').textContent = userData.email || currentUser.email;
                    document.getElementById('profile-fullname').textContent = fullName;
                    document.getElementById('profile-email-detail').textContent = userData.email || currentUser.email;
                    document.getElementById('profile-phone').textContent = userData.phone || '-';
                    document.getElementById('profile-phone-detail').textContent = userData.phone || '-';
                    
                    const role = (userData.isAdmin || userData.role === 'admin') ? 'Администратор' : 'Потребител';
                    document.getElementById('profile-role').textContent = role;
                    
                    if (userData.isAdmin || userData.role === 'admin') {
                        document.getElementById('profile-admin-badge').style.display = 'inline-block';
                    } else {
                        document.getElementById('profile-admin-badge').style.display = 'none';
                    }
                    
                    if (userData.createdAt) {
                        const date = new Date(userData.createdAt.seconds * 1000);
                        document.getElementById('profile-created').textContent = date.toLocaleDateString('bg-BG');
                    }
                    
                    if (userData.lastLogin) {
                        const date = new Date(userData.lastLogin.seconds * 1000);
                        document.getElementById('profile-lastlogin').textContent = date.toLocaleString('bg-BG');
                    }
                }
            } catch (error) {
                console.error('Грешка при зареждане на профил:', error);
            }
        }

        // ===== ФУНКЦИИ ЗА РЕДАКТИРАНЕ НА ПРОФИЛ =====
        window.editProfile = function() {
            if (!currentUser) return;
            
            db.collection('users').doc(currentUser.uid).get().then(doc => {
                if (doc.exists) {
                    const data = doc.data();
                    document.getElementById('edit-firstname').value = data.firstName || '';
                    document.getElementById('edit-lastname').value = data.lastName || '';
                    document.getElementById('edit-phone').value = data.phone || '';
                }
            });
            
            document.getElementById('editProfileModal').classList.add('active');
        };

        window.closeEditModal = function() {
            document.getElementById('editProfileModal').classList.remove('active');
        };

        window.saveProfileChanges = async function() {
            const firstName = document.getElementById('edit-firstname').value.trim();
            const lastName = document.getElementById('edit-lastname').value.trim();
            const phone = document.getElementById('edit-phone').value.trim();
            
            if (!firstName || !lastName) {
                alert('Моля, попълнете име и фамилия');
                return;
            }
            
            try {
                await db.collection('users').doc(currentUser.uid).update({
                    firstName: firstName,
                    lastName: lastName,
                    fullName: `${firstName} ${lastName}`,
                    phone: phone
                });
                
                await currentUser.updateProfile({
                    displayName: `${firstName} ${lastName}`
                });
                
                alert('Профилът е обновен успешно!');
                closeEditModal();
                loadUserProfile(currentUser.uid);
                
                // Актуализираме името в страничната лента
                document.getElementById('userName').textContent = `${firstName} ${lastName}`;
                document.getElementById('userNameEn').textContent = `${firstName} ${lastName}`;
                
            } catch (error) {
                alert('Грешка: ' + error.message);
            }
        };

        // ===== АДМИН ФУНКЦИИ =====
        async function loadAllUsers() {
            try {
                const snapshot = await db.collection('users').orderBy('createdAt', 'desc').get();
                allUsers = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                filteredUsers = [...allUsers];
                
                updateAdminStats();
                displayAdminUsers();
                setupAdminSearch();
            } catch (error) {
                console.error('Грешка при зареждане на потребители:', error);
                document.getElementById('adminUsersTableBody').innerHTML = `
                    <tr><td colspan="9" style="text-align: center; color: var(--accent);">❌ Грешка при зареждане</td></tr>
                `;
            }
        }

        function updateAdminStats() {
            document.getElementById('adminTotalUsers').textContent = allUsers.length;
            document.getElementById('adminVerifiedUsers').textContent = allUsers.filter(u => u.emailVerified).length;
            document.getElementById('adminGoogleUsers').textContent = allUsers.filter(u => u.provider === 'google').length;
            document.getElementById('adminEmailUsers').textContent = allUsers.filter(u => u.provider === 'email' || !u.provider).length;
            document.getElementById('adminAdminUsers').textContent = allUsers.filter(u => u.isAdmin || u.role === 'admin').length;
        }

        function setupAdminSearch() {
            const searchInput = document.getElementById('adminSearchInput');
            if (searchInput) {
                searchInput.addEventListener('input', (e) => {
                    const searchTerm = e.target.value.toLowerCase();
                    
                    filteredUsers = allUsers.filter(user => 
                        (user.firstName && user.firstName.toLowerCase().includes(searchTerm)) ||
                        (user.lastName && user.lastName.toLowerCase().includes(searchTerm)) ||
                        (user.fullName && user.fullName.toLowerCase().includes(searchTerm)) ||
                        (user.email && user.email.toLowerCase().includes(searchTerm))
                    );
                    
                    currentAdminPage = 1;
                    displayAdminUsers();
                });
            }
        }

        function displayAdminUsers() {
            const tbody = document.getElementById('adminUsersTableBody');
            
            if (!tbody) return;
            
            if (filteredUsers.length === 0) {
                tbody.innerHTML = '<tr><td colspan="9" style="text-align: center;">Няма потребители</td></tr>';
                document.getElementById('adminPagination').innerHTML = '';
                return;
            }

            const startIndex = (currentAdminPage - 1) * usersPerPage;
            const endIndex = startIndex + usersPerPage;
            const paginatedUsers = filteredUsers.slice(startIndex, endIndex);
            
            const currentLang = document.body.getAttribute('data-lang') || 'bg';

            tbody.innerHTML = paginatedUsers.map(user => {
                const isAdminUser = user.isAdmin || user.role === 'admin';
                const createdAt = user.createdAt ? new Date(user.createdAt.seconds * 1000).toLocaleDateString('bg-BG') : '-';
                const lastLogin = user.lastLogin ? new Date(user.lastLogin.seconds * 1000).toLocaleDateString('bg-BG') : '-';
                const favoritesCount = user.favorites ? user.favorites.length : 0;
                
                return `
                <tr>
                    <td>${user.firstName || '-'}</td>
                    <td>${user.lastName || '-'}</td>
                    <td>${user.email}</td>
                    <td>${isAdminUser ? '<span class="admin-badge">' + (currentLang === 'bg' ? 'Админ' : 'Admin') + '</span>' : '<span class="user-badge">' + (currentLang === 'bg' ? 'Потребител' : 'User') + '</span>'}</td>
                    <td>${user.emailVerified ? '✅' : '❌'}</td>
                    <td>${user.provider === 'google' ? 'Google' : (currentLang === 'bg' ? 'Имейл' : 'Email')}</td>
                    <td>${createdAt}</td>
                    <td>${lastLogin}</td>
                    <td>
                        ${!isAdminUser 
                            ? `<button class="btn-small btn-success" onclick="makeAdmin('${user.id}')">${currentLang === 'bg' ? 'Направи админ' : 'Make admin'}</button>`
                            : `<button class="btn-small btn-warning" onclick="removeAdmin('${user.id}')">${currentLang === 'bg' ? 'Премахни' : 'Remove'}</button>`
                        }
                        <button class="btn-small btn-info" onclick="viewUserDetails('${user.id}')">${currentLang === 'bg' ? 'Детайли' : 'Details'}</button>
                        <button class="btn-small btn-danger" onclick="deleteUser('${user.id}')">${currentLang === 'bg' ? 'Изтрий' : 'Delete'}</button>
                    </td>
                </tr>
            `}).join('');

            updateAdminPagination();
        }

        function updateAdminPagination() {
            const totalPages = Math.ceil(filteredUsers.length / usersPerPage);
            const pagination = document.getElementById('adminPagination');
            
            if (!pagination) return;
            
            if (totalPages <= 1) {
                pagination.innerHTML = '';
                return;
            }

            let buttons = '';
            for (let i = 1; i <= totalPages; i++) {
                buttons += `<button onclick="goToAdminPage(${i})" class="${i === currentAdminPage ? 'active' : ''}">${i}</button>`;
            }
            pagination.innerHTML = buttons;
        }

        window.goToAdminPage = function(page) {
            currentAdminPage = page;
            displayAdminUsers();
        };

        window.makeAdmin = async function(userId) {
            const currentLang = document.body.getAttribute('data-lang') || 'bg';
            if (!confirm(currentLang === 'bg' ? 'Направи този потребител администратор?' : 'Make this user an admin?')) return;
            try {
                await db.collection('users').doc(userId).update({ isAdmin: true, role: 'admin' });
                alert(currentLang === 'bg' ? '✅ Потребителят вече е администратор!' : '✅ User is now admin!');
                loadAllUsers();
            } catch (error) {
                alert('❌ Грешка: ' + error.message);
            }
        };

        window.removeAdmin = async function(userId) {
            const currentLang = document.body.getAttribute('data-lang') || 'bg';
            if (!confirm(currentLang === 'bg' ? 'Премахни администраторските права?' : 'Remove admin rights?')) return;
            try {
                await db.collection('users').doc(userId).update({ isAdmin: false, role: 'user' });
                alert(currentLang === 'bg' ? '✅ Администраторските права са премахнати!' : '✅ Admin rights removed!');
                loadAllUsers();
            } catch (error) {
                alert('❌ Грешка: ' + error.message);
            }
        };

        window.viewUserDetails = function(userId) {
            const user = allUsers.find(u => u.id === userId);
            if (!user) return;
            
            const createdAt = user.createdAt ? new Date(user.createdAt.seconds * 1000).toLocaleString('bg-BG') : '-';
            const lastLogin = user.lastLogin ? new Date(user.lastLogin.seconds * 1000).toLocaleString('bg-BG') : '-';
            const lang = document.body.getAttribute('data-lang') || 'bg';
            const favoritesCount = user.favorites ? user.favorites.length : 0;
            
            const detailsHtml = `
                <div class="user-detail-item">
                    <div class="user-detail-label">${lang === 'bg' ? 'Име и фамилия' : 'Full name'}</div>
                    <div class="user-detail-value"><i class="fas fa-user"></i> ${user.firstName || '-'} ${user.lastName || '-'}</div>
                </div>
                <div class="user-detail-item">
                    <div class="user-detail-label">Email</div>
                    <div class="user-detail-value"><i class="fas fa-envelope"></i> ${user.email}</div>
                </div>
                <div class="user-detail-item">
                    <div class="user-detail-label">${lang === 'bg' ? 'Телефон' : 'Phone'}</div>
                    <div class="user-detail-value"><i class="fas fa-phone"></i> ${user.phone || '-'}</div>
                </div>
                <div class="user-detail-item">
                    <div class="user-detail-label">${lang === 'bg' ? 'Роля' : 'Role'}</div>
                    <div class="user-detail-value"><i class="fas fa-${user.isAdmin || user.role === 'admin' ? 'crown' : 'user'}"></i> ${user.isAdmin || user.role === 'admin' ? (lang === 'bg' ? 'Администратор' : 'Admin') : (lang === 'bg' ? 'Потребител' : 'User')}</div>
                </div>
                <div class="user-detail-item">
                    <div class="user-detail-label">${lang === 'bg' ? 'Провайдър' : 'Provider'}</div>
                    <div class="user-detail-value"><i class="fab fa-${user.provider === 'google' ? 'google' : 'envelope'}"></i> ${user.provider === 'google' ? 'Google' : (lang === 'bg' ? 'Имейл/Парола' : 'Email/Password')}</div>
                </div>
                <div class="user-detail-item">
                    <div class="user-detail-label">${lang === 'bg' ? 'Имейл потвърден' : 'Email verified'}</div>
                    <div class="user-detail-value"><i class="fas fa-${user.emailVerified ? 'check-circle' : 'times-circle'}" style="color: ${user.emailVerified ? 'var(--success)' : 'var(--accent)'}"></i> ${user.emailVerified ? (lang === 'bg' ? 'Да' : 'Yes') : (lang === 'bg' ? 'Не' : 'No')}</div>
                </div>
                <div class="user-detail-item">
                    <div class="user-detail-label">${lang === 'bg' ? 'Любими места' : 'Favorites'}</div>
                    <div class="user-detail-value"><i class="fas fa-star" style="color: var(--favorite);"></i> ${favoritesCount}</div>
                </div>
                <div class="user-detail-item">
                    <div class="user-detail-label">${lang === 'bg' ? 'Регистрация' : 'Registered'}</div>
                    <div class="user-detail-value"><i class="fas fa-calendar-alt"></i> ${createdAt}</div>
                </div>
                <div class="user-detail-item">
                    <div class="user-detail-label">${lang === 'bg' ? 'Последен вход' : 'Last login'}</div>
                    <div class="user-detail-value"><i class="fas fa-clock"></i> ${lastLogin}</div>
                </div>
            `;
            
            document.getElementById('userDetailsContent').innerHTML = detailsHtml;
            document.getElementById('userDetailsModal').classList.add('active');
        };

        window.closeUserDetailsModal = function() {
            document.getElementById('userDetailsModal').classList.remove('active');
        };

        window.deleteUser = async function(userId) {
            const currentLang = document.body.getAttribute('data-lang') || 'bg';
            if (!confirm(currentLang === 'bg' ? '🚨 ВНИМАНИЕ! Сигурни ли сте, че искате да изтриете този потребител? Това действие е необратимо!' : '🚨 WARNING! Are you sure you want to delete this user? This action is irreversible!')) return;
            
            try {
                await db.collection('users').doc(userId).delete();
                alert(currentLang === 'bg' ? '✅ Потребителят е изтрит!' : '✅ User deleted!');
                loadAllUsers();
                closeUserDetailsModal();
            } catch (error) {
                alert('❌ Грешка: ' + error.message);
            }
        };

        // ===== ФУНКЦИИ ЗА RTDB (ПАРКОМЕСТА) =====
        function setupFirebaseListeners() {
            // Слушател за място 1 (инвалиди)
            rtdb.ref('parking/spot1').on('value', (snapshot) => {
                const data = snapshot.val();
                if (data) {
                    spot1Distance = data.distance || -1;
                    spot1Status = data.status || "ГРЕШКА";
                    
                    console.log("Място 1 обновено:", spot1Status, spot1Distance);
                    
                    // Актуализираме UI само ако има логнат потребител
                    if (currentUser) {
                        updateSpotStatus(1, spot1Status, spot1Distance);
                    }
                    if (map && parkingPolygons.length > 0 && currentUser) {
                        updateMapColors();
                    }
                    updateLastUpdateTime();
                    updateFreeSpotsCount();
                    
                    // Актуализираме любимите, ако страницата е активна
                    if (document.getElementById('favorites-page').classList.contains('active')) {
                        displayFavorites();
                    }
                }
            });
            
            // Слушател за място 2
            rtdb.ref('parking/spot2').on('value', (snapshot) => {
                const data = snapshot.val();
                if (data) {
                    spot2Distance = data.distance || -1;
                    spot2Status = data.status || "ГРЕШКА";
                    
                    console.log("Място 2 обновено:", spot2Status, spot2Distance);
                    
                    // Актуализираме UI само ако има логнат потребител
                    if (currentUser) {
                        updateSpotStatus(2, spot2Status, spot2Distance);
                    }
                    if (map && parkingPolygons.length > 0 && currentUser) {
                        updateMapColors();
                    }
                    updateLastUpdateTime();
                    updateFreeSpotsCount();
                    
                    // Актуализираме любимите, ако страницата е активна
                    if (document.getElementById('favorites-page').classList.contains('active')) {
                        displayFavorites();
                    }
                }
            });
            
            console.log("Firebase слушатели са активирани");
        }

        function updateSpotStatus(spotNumber, status, distance) {
            const statusElement = document.getElementById('status' + spotNumber);
            if (!statusElement) return;
            
            let statusClass = '';
            let icon = '';
            
            if (spotNumber === 1) {
                if (status === "ЗАЕТО") {
                    statusClass = "status-disabled-occupied";
                    icon = '<i class="fas fa-times-circle"></i>';
                } else if (status === "ПРАЗНО") {
                    statusClass = "status-disabled-empty";
                    icon = '<i class="fas fa-check-circle"></i>';
                } else {
                    statusClass = "status-pending";
                    icon = '<i class="fas fa-spinner fa-spin"></i>';
                }
            } else {
                if (status === "ЗАЕТО") {
                    statusClass = "status-occupied";
                    icon = '<i class="fas fa-times-circle"></i>';
                } else if (status === "ПРАЗНО") {
                    statusClass = "status-empty";
                    icon = '<i class="fas fa-check-circle"></i>';
                } else {
                    statusClass = "status-pending";
                    icon = '<i class="fas fa-spinner fa-spin"></i>';
                }
            }
            
            const currentLang = document.body.getAttribute('data-lang') || 'bg';
            let statusText = status;
            
            if (currentLang === 'en') {
                if (status === "ЗАЕТО") statusText = "OCCUPIED";
                else if (status === "ПРАЗНО") statusText = "FREE";
                else if (status === "ЗАРЕЖДАНЕ") statusText = "LOADING";
                else if (status === "ГРЕШКА") statusText = "ERROR";
            }
            
            statusElement.innerHTML = icon + ' ' + statusText;
            statusElement.className = 'status-value ' + statusClass;
            
            if (distance > 0) {
                statusElement.title = (currentLang === 'bg' ? 'Разстояние: ' : 'Distance: ') + distance + ' cm';
            }
        }

        function updateMapColors() {
            if (!map || parkingPolygons.length === 0 || !currentUser) return;
            
            for (let i = 0; i < parkingPolygons.length; i++) {
                let fillColor;
                
                if (i === 0) {
                    fillColor = spot1Status === "ЗАЕТО" ? '#b71c1c' : '#0066cc';
                } else if (i === 1) {
                    fillColor = spot2Status === "ЗАЕТО" ? '#ea4335' : '#34a853';
                } else {
                    fillColor = '#34a853';
                }
                
                parkingPolygons[i].setStyle({ fillColor: fillColor });
            }
        }

        function updateFreeSpotsCount() {
            let free = 1; // Място 3 винаги свободно
            
            if (spot1Status === "ПРАЗНО") free++;
            if (spot2Status === "ПРАЗНО") free++;
            
            const freeSpotsElement = document.getElementById('freeSpots');
            if (freeSpotsElement) {
                freeSpotsElement.textContent = free;
            }
        }

        function updateLastUpdateTime() {
            lastUpdateTime = new Date();
            const timeString = lastUpdateTime.toLocaleTimeString('bg-BG', {
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });
            
            const lastUpdateElement = document.getElementById('lastUpdate');
            if (lastUpdateElement) {
                lastUpdateElement.innerHTML = '<i class="far fa-clock"></i> ' + timeString;
            }
        }

        window.manualRefresh = function() {
            const refreshBtn = document.querySelector('.controls button i');
            if (refreshBtn) {
                refreshBtn.className = 'fas fa-spinner fa-spin';
            }
            
            // Ръчно актуализиране на данните
            rtdb.ref('parking').once('value').then((snapshot) => {
                const data = snapshot.val();
                if (data) {
                    if (data.spot1) {
                        spot1Distance = data.spot1.distance || -1;
                        spot1Status = data.spot1.status || "ГРЕШКА";
                        if (currentUser) updateSpotStatus(1, spot1Status, spot1Distance);
                    }
                    if (data.spot2) {
                        spot2Distance = data.spot2.distance || -1;
                        spot2Status = data.spot2.status || "ГРЕШКА";
                        if (currentUser) updateSpotStatus(2, spot2Status, spot2Distance);
                    }
                    if (map && parkingPolygons.length > 0 && currentUser) {
                        updateMapColors();
                    }
                    updateLastUpdateTime();
                    updateFreeSpotsCount();
                    
                    // Актуализираме любимите, ако страницата е активна
                    if (document.getElementById('favorites-page').classList.contains('active')) {
                        displayFavorites();
                    }
                }
                if (refreshBtn) {
                    refreshBtn.className = 'fas fa-sync-alt';
                }
            }).catch((error) => {
                console.error("Грешка при ръчно актуализиране:", error);
                if (refreshBtn) {
                    refreshBtn.className = 'fas fa-exclamation-triangle';
                    setTimeout(() => {
                        refreshBtn.className = 'fas fa-sync-alt';
                    }, 2000);
                }
            });
        };

        // ===== ФУНКЦИИ ЗА КАРТАТА =====
        const centerLat = 42.8768;
        const centerLng = 25.3179;
        const parkingWidth = 3.0;
        const parkingLength = 6.0;
        const spaceBetween = 0.5;
        
        function metersToDegrees(meters) {
            return meters / 111111;
        }

        function initializeMap() {
            // Проверка дали картата вече е инициализирана
            if (map !== null) {
                console.log("Картата вече е инициализирана");
                return;
            }
            
            // Проверка дали елементът съществува
            const mapElement = document.getElementById('map');
            if (!mapElement) {
                console.error("Елементът за карта не е намерен");
                setTimeout(initializeMap, 500);
                return;
            }
            
            try {
                console.log("Инициализиране на карта...");
                
                // Създаване на картата
                map = L.map('map').setView([centerLat, centerLng], 18.5);
                
                // Добавяне на стандартен OpenStreetMap слой
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
                    maxZoom: 22
                }).addTo(map);
                
                // Създаване на паркоместата
                createParkingSpots();
                
                // Добавяне на събитие за преоразмеряване
                setTimeout(() => {
                    map.invalidateSize();
                }, 500);
                
                console.log("Картата е инициализирана успешно");
            } catch (error) {
                console.error("Грешка при инициализиране на картата:", error);
                // Опитай пак след 1 секунда
                setTimeout(initializeMap, 1000);
            }
        }

        function createParkingSpots() {
            if (!map) {
                console.error("Картата не е инициализирана");
                return;
            }
            
            console.log("Създаване на паркоместа...");
            
            parkingPolygons = [];
            
            for (let i = 0; i < 3; i++) {
                const spotId = `spot${i+1}`;
                const offsetLng = metersToDegrees(i * (parkingWidth + spaceBetween));
                const totalWidth = 3 * parkingWidth + 2 * spaceBetween;
                const centerOffset = metersToDegrees(totalWidth / 2);
                
                const spotLat = centerLat;
                const spotLng = centerLng + offsetLng - centerOffset;
                
                // Запазваме координатите в данните за мястото
                parkingSpotsData[i].lat = spotLat;
                parkingSpotsData[i].lng = spotLng;
                
                const halfWidth = metersToDegrees(parkingWidth) / 2;
                const halfLength = metersToDegrees(parkingLength) / 2;
                
                // Ъглите на правоъгълника
                const corners = [
                    [spotLat - halfLength, spotLng - halfWidth],
                    [spotLat - halfLength, spotLng + halfWidth],
                    [spotLat + halfLength, spotLng + halfWidth],
                    [spotLat + halfLength, spotLng - halfWidth]
                ];
                
                // Определяне на цвета според статуса и типа място
                let fillColor;
                if (i === 0) {
                    fillColor = (currentUser && spot1Status === "ЗАЕТО") ? '#b71c1c' : '#0066cc';
                } else if (i === 1) {
                    fillColor = (currentUser && spot2Status === "ЗАЕТО") ? '#ea4335' : '#34a853';
                } else {
                    fillColor = '#34a853';
                }
                
                // Създаване на паркомястото
                const parkingSpace = L.polygon(corners, {
                    color: '#ffffff',
                    fillColor: fillColor,
                    fillOpacity: 0.8,
                    weight: 2
                }).addTo(map);
                
                parkingPolygons.push(parkingSpace);
                
                // Добавяне на номер с икона
                let labelHtml;
                if (i === 0) {
                    labelHtml = '<div style="background: white; color: ' + fillColor + '; font-weight: 700; font-size: 16px; width: 44px; height: 44px; border-radius: 30px; display: flex; flex-direction: column; align-items: center; justify-content: center; border: 3px solid ' + fillColor + '; box-shadow: 0 4px 12px rgba(0,0,0,0.2); font-family: \'Segoe UI\', sans-serif; line-height: 1.2; background: rgba(255,255,255,0.98);"><span style="font-size: 12px;">' + (i + 1) + '</span><i class="fas fa-wheelchair" style="font-size: 18px;"></i></div>';
                } else {
                    labelHtml = '<div style="background: white; color: ' + fillColor + '; font-weight: 700; font-size: 18px; width: 38px; height: 38px; border-radius: 30px; display: flex; align-items: center; justify-content: center; border: 3px solid ' + fillColor + '; box-shadow: 0 4px 12px rgba(0,0,0,0.2); font-family: \'Segoe UI\', sans-serif; background: rgba(255,255,255,0.98);">' + (i + 1) + '</div>';
                }
                
                L.marker([spotLat, spotLng], {
                    icon: L.divIcon({
                        className: 'parking-label',
                        html: labelHtml,
                        iconSize: i === 0 ? [44, 44] : [38, 38],
                        iconAnchor: i === 0 ? [22, 22] : [19, 19]
                    })
                }).addTo(map);
                
                // Информация при клик
                let statusText = spot1Status;
                if (i === 1) statusText = spot2Status;
                else if (i === 2) statusText = "СВОБОДНО";
                
                const currentLang = document.body.getAttribute('data-lang') || 'bg';
                
                let popupContent = '<div style="text-align: center; min-width: 280px;">';
                popupContent += '<div style="display: flex; align-items: center; justify-content: center; gap: 8px; margin-bottom: 8px;">';
                popupContent += '<div style="background: ' + fillColor + '; color: white; width: 36px; height: 36px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 18px;">' + (i + 1) + '</div>';
                popupContent += (i === 0 ? '<i class="fas fa-wheelchair" style="color: #0066cc; font-size: 24px;"></i>' : '');
                popupContent += '</div>';
                popupContent += '<h3 style="margin: 0 0 8px; color: #1a2639; font-weight: 600;">Паркомясто ' + (i + 1) + '</h3>';
                
                if (i === 0) {
                    popupContent += '<p style="margin: 0 0 8px; font-size: 14px; color: #0066cc; font-weight: 600; background: #e3f2fd; padding: 4px 12px; border-radius: 30px; display: inline-block;">✦ За хора с увреждания ✦</p>';
                }
                
                popupContent += '<p style="margin: 0 0 12px; font-size: 13px; color: #5a6a7a;"><i class="fas fa-map-marker-alt" style="color: #ea4335;"></i> ул. "Епископ Софроний", Габрово</p>';
                popupContent += '<div style="text-align: left; font-size: 13px; background: #f8f9fa; padding: 12px; border-radius: 12px;">';
                popupContent += '<div style="margin-bottom: 8px; display: flex; align-items: center; gap: 8px;">';
                popupContent += '<i class="fas fa-circle" style="color: ' + fillColor + '; font-size: 10px;"></i><strong>Статус:</strong> <span style="color: ' + fillColor + '; font-weight: 700;">' + statusText + '</span>';
                popupContent += '</div>';
                
                if (i === 0 && currentUser) {
                    popupContent += '<div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;"><i class="fas fa-ruler"></i><strong>Разстояние:</strong> ' + spot1Distance + ' см</div>';
                }
                if (i === 1 && currentUser) {
                    popupContent += '<div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;"><i class="fas fa-ruler"></i><strong>Разстояние:</strong> ' + spot2Distance + ' см</div>';
                }
                
                if (!currentUser) {
                    popupContent += '<div style="margin-top: 8px; padding: 8px; background: #fff3cd; border-radius: 8px; color: #856404;"><i class="fas fa-lock"></i> Влезте, за да видите статуса</div>';
                } else {
                    const favoriteText = isFavorite(spotId) ? 
                        (currentLang === 'bg' ? 'Премахни от любими' : 'Remove from favorites') : 
                        (currentLang === 'bg' ? 'Добави към любими' : 'Add to favorites');
                    
                    const favoriteIcon = isFavorite(spotId) ? 'fas fa-star' : 'far fa-star';
                    const favoriteClass = isFavorite(spotId) ? 'btn-warning' : 'btn-favorite';
                    
                    popupContent += '<div style="display: flex; gap: 8px; margin-top: 12px;">';
                    popupContent += '<button class="btn-small ' + favoriteClass + ' favorite-btn" onclick="toggleFavorite(\'' + spotId + '\')" data-spot-id="' + spotId + '" style="flex: 1;"><i class="' + favoriteIcon + '"></i> ' + favoriteText + '</button>';
                    popupContent += '<button class="btn-small btn-success" onclick="navigateToSpot(' + spotLat + ', ' + spotLng + ', \'' + (i === 0 ? 'Място 1' : i === 1 ? 'Място 2' : 'Място 3') + '\')" style="flex: 1;"><i class="fas fa-directions"></i> ' + (currentLang === 'bg' ? 'Навигирай' : 'Navigate') + '</button>';
                    popupContent += '</div>';
                }
                
                popupContent += '</div></div>';
                
                parkingSpace.bindPopup(popupContent);
            }
            
            console.log("Паркоместата са създадени успешно");
        }

        // ===== ФУНКЦИИ ЗА АУТЕНТИКАЦИЯ =====
        async function registerUser(email, password, firstName, lastName, phone) {
            if (!email || !password || !firstName || !lastName) {
                showError('register-error', '❌ Моля, попълнете всички задължителни полета');
                return;
            }
            
            if (password.length < 6) {
                showError('register-error', '❌ Паролата трябва да е поне 6 символа');
                return;
            }
            
            if (password !== document.getElementById('register-confirm').value) {
                showError('register-error', '❌ Паролите не съвпадат');
                return;
            }
            
            const registerBtn = document.querySelector('#register-form button[type="submit"]');
            const originalText = registerBtn.innerHTML;
            registerBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Регистрация...';
            registerBtn.disabled = true;
            
            try {
                const userCredential = await auth.createUserWithEmailAndPassword(email, password);
                const user = userCredential.user;
                
                await user.updateProfile({
                    displayName: `${firstName} ${lastName}`
                });
                
                await db.collection('users').doc(user.uid).set({
                    firstName: firstName,
                    lastName: lastName,
                    fullName: `${firstName} ${lastName}`,
                    email: email,
                    phone: phone || '',
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    lastLogin: firebase.firestore.FieldValue.serverTimestamp(),
                    emailVerified: false,
                    provider: 'email',
                    isAdmin: false,
                    role: 'user',
                    favorites: []
                });
                
                await user.sendEmailVerification();
                
                showSuccess('register-success', `✅ Регистрацията е успешна! Изпратихме имейл за потвърждение до <strong>${email}</strong>.`);
                
                document.getElementById('register-form').reset();
                
                setTimeout(() => {
                    document.querySelector('[data-page=login]').click();
                }, 3000);
                
            } catch (error) {
                console.error('Registration error:', error);
                
                let errorMessage = '';
                switch(error.code) {
                    case 'auth/email-already-in-use':
                        errorMessage = '❌ Този имейл вече е регистриран.';
                        break;
                    case 'auth/invalid-email':
                        errorMessage = '❌ Невалиден имейл адрес';
                        break;
                    case 'auth/weak-password':
                        errorMessage = '❌ Паролата е твърде слаба (минимум 6 символа)';
                        break;
                    default:
                        errorMessage = '❌ Грешка при регистрация: ' + error.message;
                }
                
                showError('register-error', errorMessage);
            } finally {
                registerBtn.innerHTML = originalText;
                registerBtn.disabled = false;
            }
        }

        async function loginUser(email, password) {
            if (!email || !password) {
                showError('login-error', '❌ Моля, попълнете имейл и парола');
                return;
            }
            
            const loginBtn = document.querySelector('#login-form button[type="submit"]');
            const originalText = loginBtn.innerHTML;
            loginBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Вход...';
            loginBtn.disabled = true;
            
            try {
                const userCredential = await auth.signInWithEmailAndPassword(email, password);
                const user = userCredential.user;
                
                if (!user.emailVerified) {
                    await auth.signOut();
                    
                    const resendButton = `<br><br><button class="btn" onclick="resendVerificationEmail('${email}')" style="padding: 8px 16px; font-size: 0.9rem;">Изпрати отново имейл за потвърждение</button>`;
                    
                    showError('login-error', `❌ Имейлът <strong>${email}</strong> не е потвърден. Моля, проверете пощата си.${resendButton}`);
                    
                    loginBtn.innerHTML = originalText;
                    loginBtn.disabled = false;
                    return;
                }
                
                await db.collection('users').doc(user.uid).update({
                    lastLogin: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                showSuccess('login-success', '✅ Успешен вход! Пренасочване...');
                
                setTimeout(() => {
                    document.querySelector('[data-page=map]').click();
                }, 1500);
                
            } catch (error) {
                console.error('Login error:', error);
                
                let errorMessage = '';
                switch(error.code) {
                    case 'auth/invalid-email':
                        errorMessage = '❌ Невалиден имейл адрес';
                        break;
                    case 'auth/user-disabled':
                        errorMessage = '❌ Потребителят е деактивиран';
                        break;
                    case 'auth/user-not-found':
                        errorMessage = '❌ Няма потребител с този имейл';
                        break;
                    case 'auth/wrong-password':
                        errorMessage = '❌ Грешна парола';
                        break;
                    default:
                        errorMessage = '❌ Грешка при вход: ' + error.message;
                }
                
                showError('login-error', errorMessage);
                
                loginBtn.innerHTML = originalText;
                loginBtn.disabled = false;
            }
        }

        async function logoutUser() {
            try {
                await auth.signOut();
                showSuccess('login-success', '✅ Успешен изход');
                document.querySelector('[data-page=map]').click();
            } catch (error) {
                console.error('Logout error:', error);
            }
        }

        async function signInWithGoogle(mode) {
            const provider = new firebase.auth.GoogleAuthProvider();
            
            try {
                const result = await auth.signInWithPopup(provider);
                const user = result.user;
                
                const userDoc = await db.collection('users').doc(user.uid).get();
                
                if (!userDoc.exists) {
                    let firstName = '';
                    let lastName = '';
                    
                    if (user.displayName) {
                        const nameParts = user.displayName.split(' ');
                        firstName = nameParts[0] || '';
                        lastName = nameParts.slice(1).join(' ') || '';
                    }
                    
                    await db.collection('users').doc(user.uid).set({
                        firstName: firstName,
                        lastName: lastName,
                        fullName: user.displayName || '',
                        email: user.email,
                        photoURL: user.photoURL || '',
                        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                        lastLogin: firebase.firestore.FieldValue.serverTimestamp(),
                        emailVerified: user.emailVerified,
                        provider: 'google',
                        isAdmin: false,
                        role: 'user',
                        favorites: []
                    });
                    
                    showSuccess(mode === 'login' ? 'login-success' : 'register-success', '✅ Успешна регистрация с Google!');
                } else {
                    await db.collection('users').doc(user.uid).update({
                        lastLogin: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    
                    showSuccess(mode === 'login' ? 'login-success' : 'register-success', '✅ Успешен вход с Google!');
                }
                
                setTimeout(() => {
                    document.querySelector('[data-page=map]').click();
                }, 1500);
                
            } catch (error) {
                console.error('Google auth error:', error);
                
                let errorMessage = '';
                switch(error.code) {
                    case 'auth/popup-closed-by-user':
                        errorMessage = '❌ Прозорецът за вход беше затворен.';
                        break;
                    case 'auth/popup-blocked':
                        errorMessage = '❌ Изскачащият прозорец беше блокиран.';
                        break;
                    default:
                        errorMessage = '❌ Грешка: ' + error.message;
                }
                
                showError(mode === 'login' ? 'login-error' : 'register-error', errorMessage);
            }
        }

        window.resendVerificationEmail = async function(email) {
            const password = prompt('За да изпратите нов имейл за потвърждение, моля въведете паролата си:');
            
            if (!password) return;
            
            try {
                const userCredential = await auth.signInWithEmailAndPassword(email, password);
                const user = userCredential.user;
                
                await user.sendEmailVerification();
                await auth.signOut();
                
                showSuccess('login-success', '✅ Имейл за потвърждение е изпратен отново!');
            } catch (error) {
                showError('login-error', '❌ Грешка: ' + error.message);
            }
        };

        // ===== ФУНКЦИИ ЗА ТЕМА И ЕЗИК =====
        function toggleTheme() {
            document.body.classList.toggle('dark-theme');
            const isDarkTheme = document.body.classList.contains('dark-theme');
            localStorage.setItem('theme', isDarkTheme ? 'dark' : 'light');
        }

        function loadTheme() {
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme === 'dark') {
                document.body.classList.add('dark-theme');
                const darkmodeToggle = document.getElementById('darkmode-toggle');
                if (darkmodeToggle) darkmodeToggle.checked = true;
            }
        }

        function setLanguage(lang) {
            document.body.setAttribute('data-lang', lang);
            localStorage.setItem('language', lang);
            
            // Актуализиране на статусите на паркоместата според езика
            if (currentUser) {
                updateSpotStatus(1, spot1Status, spot1Distance);
                updateSpotStatus(2, spot2Status, spot2Distance);
            } else {
                updateSpotStatus(1, "ЗАРЕЖДАНЕ", -1);
                updateSpotStatus(2, "ЗАРЕЖДАНЕ", -1);
            }
            
            // Актуализиране на времето за последна актуализация
            updateLastUpdateTime();
            
            // Актуализиране на заглавието на страницата
            const pageTitle = document.getElementById('page-title');
            const activePage = document.querySelector('.page.active');
            if (activePage) {
                const pageId = activePage.id.replace('-page', '');
                const pageNames = {
                    'map': lang === 'bg' ? 'Карта' : 'Map',
                    'favorites': lang === 'bg' ? 'Любими' : 'Favorites',
                    'profile': lang === 'bg' ? 'Профил' : 'Profile',
                    'login': lang === 'bg' ? 'Вход' : 'Login',
                    'register': lang === 'bg' ? 'Регистрация' : 'Register',
                    'admin': lang === 'bg' ? 'Админ' : 'Admin',
                    'settings': lang === 'bg' ? 'Настройки' : 'Settings'
                };
                pageTitle.textContent = pageNames[pageId];
            }
            
            // Актуализиране на админ таблицата ако е активна
            if (isAdmin && document.getElementById('admin-page').classList.contains('active')) {
                displayAdminUsers();
            }
            
            // Актуализиране на любимите ако страницата е активна
            if (document.getElementById('favorites-page').classList.contains('active')) {
                displayFavorites();
            }
        }

        function loadLanguage() {
            const savedLanguage = localStorage.getItem('language') || 'bg';
            setLanguage(savedLanguage);
            
            const languageSelect = document.getElementById('language-select');
            if (languageSelect) {
                languageSelect.value = savedLanguage;
            }
        }

        // ===== ИНИЦИАЛИЗАЦИЯ =====
        document.addEventListener('DOMContentLoaded', function() {
            console.log("DOM зареден, инициализиране...");
            
            loadTheme();
            loadLanguage();
            
            // Инициализиране на картата с малко закъснение
            setTimeout(function() {
                initializeMap();
            }, 500);
            
            // Настройка на Firebase слушатели
            setupFirebaseListeners();
            
            // Първоначално ръчно зареждане на данни
            setTimeout(manualRefresh, 1500);
            
            // Слушател за състоянието на аутентикация
            auth.onAuthStateChanged((user) => {
                console.log("Auth state променен:", user ? user.email : "няма потребител");
                updateUIBasedOnAuth(user);
                
                // Актуализираме картата ако вече е създадена
                if (map && parkingPolygons.length > 0) {
                    // Премахваме старите полигони и създаваме нови с актуални цветове
                    parkingPolygons.forEach(polygon => map.removeLayer(polygon));
                    parkingPolygons = [];
                    createParkingSpots();
                }
            });
            
            // Навигация между страниците
            const navItems = document.querySelectorAll('.nav-item');
            const pages = document.querySelectorAll('.page');
            const pageTitle = document.getElementById('page-title');
            
            navItems.forEach(function(item) {
                item.addEventListener('click', function() {
                    const pageId = this.getAttribute('data-page');
                    
                    if (pageId === 'logout') {
                        logoutUser();
                        return;
                    }
                    
                    // Проверка за достъп до защитени страници
                    if ((pageId === 'profile' || pageId === 'favorites' || pageId === 'admin') && !currentUser) {
                        const currentLang = document.body.getAttribute('data-lang') || 'bg';
                        alert(currentLang === 'bg' ? 'Моля, влезте в профила си, за да достъпите тази страница.' : 'Please login to access this page.');
                        document.querySelector('[data-page=login]').click();
                        return;
                    }
                    
                    // Проверка за достъп до админ панел
                    if (pageId === 'admin' && !isAdmin) {
                        const currentLang = document.body.getAttribute('data-lang') || 'bg';
                        alert(currentLang === 'bg' ? 'Нямате администраторски права!' : 'You do not have admin privileges!');
                        return;
                    }
                    
                    navItems.forEach(function(nav) {
                        nav.classList.remove('active');
                    });
                    this.classList.add('active');
                    
                    pages.forEach(function(page) {
                        page.classList.remove('active');
                        if (page.id === pageId + '-page') {
                            page.classList.add('active');
                            
                            const currentLang = document.body.getAttribute('data-lang') || 'bg';
                            const pageNames = {
                                'map': currentLang === 'bg' ? 'Карта' : 'Map',
                                'favorites': currentLang === 'bg' ? 'Любими' : 'Favorites',
                                'profile': currentLang === 'bg' ? 'Профил' : 'Profile',
                                'login': currentLang === 'bg' ? 'Вход' : 'Login',
                                'register': currentLang === 'bg' ? 'Регистрация' : 'Register',
                                'admin': currentLang === 'bg' ? 'Админ' : 'Admin',
                                'settings': currentLang === 'bg' ? 'Настройки' : 'Settings'
                            };
                            pageTitle.textContent = pageNames[pageId];
                            
                            if (pageId === 'map' && map) {
                                setTimeout(() => map.invalidateSize(), 300);
                            }
                            
                            if (pageId === 'admin' && isAdmin) {
                                loadAllUsers();
                            }
                            
                            if (pageId === 'favorites' && currentUser) {
                                displayFavorites();
                            }
                        }
                    });
                });
            });
            
            // Клик върху потребителската информация
            document.getElementById('userInfo').addEventListener('click', function() {
                if (currentUser) {
                    document.querySelector('[data-page=profile]').click();
                } else {
                    document.querySelector('[data-page=login]').click();
                }
            });
            
            // Форма за вход
            document.getElementById('login-form').addEventListener('submit', function(e) {
                e.preventDefault();
                const email = document.getElementById('login-email').value;
                const password = document.getElementById('login-password').value;
                loginUser(email, password);
            });
            
            // Форма за регистрация
            document.getElementById('register-form').addEventListener('submit', function(e) {
                e.preventDefault();
                const firstName = document.getElementById('register-firstname').value;
                const lastName = document.getElementById('register-lastname').value;
                const email = document.getElementById('register-email').value;
                const phone = document.getElementById('register-phone').value;
                const password = document.getElementById('register-password').value;
                
                registerUser(email, password, firstName, lastName, phone);
            });
            
            document.getElementById('editProfileBtn').addEventListener('click', editProfile);
            
            // Забравена парола
            document.getElementById('forgotPasswordLink').addEventListener('click', function(e) {
                e.preventDefault();
                const email = document.getElementById('login-email').value;
                
                if (!email) {
                    showError('login-error', '❌ Моля, въведете имейл за възстановяване на паролата');
                    return;
                }
                
                auth.sendPasswordResetEmail(email)
                    .then(() => {
                        showSuccess('login-success', `✅ Изпратен е имейл за възстановяване на паролата до <strong>${email}</strong>`);
                    })
                    .catch((error) => {
                        if (error.code === 'auth/user-not-found') {
                            showError('login-error', '❌ Няма потребител с този имейл');
                        } else {
                            showError('login-error', '❌ Грешка: ' + error.message);
                        }
                    });
            });
            
            document.getElementById('forgotPasswordLinkEn').addEventListener('click', function(e) {
                e.preventDefault();
                document.getElementById('forgotPasswordLink').click();
            });
            
            // Google вход
            document.getElementById('googleLoginBtn').addEventListener('click', () => signInWithGoogle('login'));
            document.getElementById('googleRegisterBtn').addEventListener('click', () => signInWithGoogle('register'));
            
            // Бутон за търсене
            document.getElementById('search-btn').addEventListener('click', function() {
                const searchTerm = document.getElementById('search-input').value;
                if (searchTerm.trim() !== '') {
                    const currentLang = document.body.getAttribute('data-lang') || 'bg';
                    alert(currentLang === 'bg' ? 'Търсене за: "' + searchTerm + '"' : 'Searching for: "' + searchTerm + '"');
                }
            });
            
            // Тъмна тема toggle
            const darkmodeToggle = document.getElementById('darkmode-toggle');
            if (darkmodeToggle) {
                darkmodeToggle.addEventListener('change', toggleTheme);
            }
            
            // Език select
            const languageSelect = document.getElementById('language-select');
            if (languageSelect) {
                languageSelect.addEventListener('change', function() {
                    setLanguage(this.value);
                });
            }
            
            // Бутон за изход от профил страницата
            document.getElementById('logoutProfileBtn').addEventListener('click', logoutUser);
            
            // Контакти
            const contactBubble = document.getElementById('contactBubble');
            const contactModal = document.getElementById('contactModal');
            const closeModal = document.getElementById('closeModal');
            const contactForm = document.getElementById('contactForm');
            
            contactBubble.addEventListener('click', function() {
                contactModal.classList.toggle('active');
            });
            
            closeModal.addEventListener('click', function() {
                contactModal.classList.remove('active');
            });
            
            document.addEventListener('click', function(event) {
                if (!contactModal.contains(event.target) && !contactBubble.contains(event.target) && contactModal.classList.contains('active')) {
                    contactModal.classList.remove('active');
                }
            });
            
            contactForm.addEventListener('submit', function(e) {
                e.preventDefault();
                const message = this.querySelector('textarea').value;
                if (message.trim() !== '') {
                    const currentLang = document.body.getAttribute('data-lang') || 'bg';
                    alert(currentLang === 'bg' ? 'Вашето съобщение беше изпратено успешно!' : 'Your message was sent successfully!');
                    this.querySelector('textarea').value = '';
                    contactModal.classList.remove('active');
                }
            });
            
            contactModal.addEventListener('click', function(e) {
                e.stopPropagation();
            });
            
            // Затваряне на модалните прозорци при клик извън тях
            document.getElementById('userDetailsModal').addEventListener('click', function(e) {
                if (e.target === this) {
                    closeUserDetailsModal();
                }
            });
            
            document.getElementById('editProfileModal').addEventListener('click', function(e) {
                if (e.target === this) {
                    closeEditModal();
                }
            });
        });
        
        console.log("Система за мониторинг на паркинг места - Габрово");
        console.log("Използва два Firebase проекта:");
        console.log("- Authentication & Firestore: registration-88c86");
        console.log("- Realtime Database: esp32-5d620");
    </script>
</body>
</html>
