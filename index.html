<!DOCTYPE html>
<html lang="bg">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>4 Паркоместа - ул. Епископ Софроний, Габрово</title>
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
          integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
          crossorigin=""/>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body, html {
            height: 100%;
            width: 100%;
            font-family: Arial, sans-serif;
            overflow: hidden;
            background: #f0f0f0;
        }
        
        #map {
            height: 100vh;
            width: 100%;
        }
        
        /* Заглавие */
        .map-title {
            position: absolute;
            top: 15px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1000;
            background: white;
            padding: 12px 20px;
            border-radius: 6px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
            text-align: center;
            min-width: 250px;
        }
        
        .map-title h2 {
            color: #222;
            font-size: 1.2rem;
            margin-bottom: 3px;
        }
        
        .map-title p {
            color: #555;
            font-size: 0.9rem;
            margin: 0;
        }
        
        /* Брой на паркоместата */
        .parking-counter {
            position: absolute;
            bottom: 20px;
            right: 20px;
            background: white;
            padding: 8px 12px;
            border-radius: 4px;
            box-shadow: 0 1px 4px rgba(0,0,0,0.1);
            font-size: 14px;
            z-index: 1000;
        }
        
        /* Статус панел */
        .status-panel {
            position: absolute;
            top: 80px;
            right: 20px;
            background: white;
            padding: 15px;
            border-radius: 6px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.15);
            z-index: 1000;
            min-width: 200px;
        }
        
        .status-title {
            font-size: 16px;
            font-weight: bold;
            margin-bottom: 10px;
            color: #333;
            text-align: center;
            border-bottom: 1px solid #eee;
            padding-bottom: 5px;
        }
        
        .status-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
            padding: 5px 0;
        }
        
        .spot-number {
            font-weight: bold;
            color: #333;
        }
        
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }
        
        .status-text {
            font-size: 14px;
            font-weight: bold;
        }
        
        .status-empty {
            color: #4CAF50;
        }
        
        .status-occupied {
            color: #f44336;
        }
        
        .status-error {
            color: #FF9800;
        }
        
        .last-update {
            font-size: 11px;
            color: #777;
            text-align: center;
            margin-top: 10px;
            border-top: 1px solid #eee;
            padding-top: 5px;
        }
        
        /* Контроли за рестарт */
        .controls {
            position: absolute;
            bottom: 20px;
            left: 20px;
            background: white;
            padding: 10px;
            border-radius: 6px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
            z-index: 1000;
        }
        
        .controls button {
            background: #4285f4;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        
        .controls button:hover {
            background: #3367d6;
        }
    </style>
</head>
<body>
    <div id="map"></div>
    
    <div class="map-title">
        <h2>ул. "Епископ Софроний"</h2>
        <p>Габрово • 4 паркоместа</p>
    </div>
    
    <div class="status-panel">
        <div class="status-title">СТАТУС НА ПАРКИНГ</div>
        <div class="status-item">
            <div>
                <span class="spot-number">Място 1:</span>
            </div>
            <div>
                <span id="status1" class="status-text status-error">Зареждане...</span>
            </div>
        </div>
        <div class="status-item">
            <div>
                <span class="spot-number">Място 2:</span>
            </div>
            <div>
                <span id="status2" class="status-text status-error">Зареждане...</span>
            </div>
        </div>
        <div class="status-item">
            <div>
                <span class="spot-number">Място 3:</span>
            </div>
            <div>
                <span id="status3" class="status-text status-empty">СВОБОДНО</span>
            </div>
        </div>
        <div class="status-item">
            <div>
                <span class="spot-number">Място 4:</span>
            </div>
            <div>
                <span id="status4" class="status-text status-empty">СВОБОДНО</span>
            </div>
        </div>
        <div class="last-update" id="lastUpdate">
            Последна актуализация: --
        </div>
    </div>
    
    <div class="parking-counter">
        <strong>4 места</strong><br>
        Размери: 3.0m × 6.0m
    </div>
    
    <div class="controls">
        <button onclick="manualRefresh()">Актуализирай статус</button>
    </div>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
            integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
            crossorigin=""></script>
    
    <script>
        // ===== Firebase конфигурация =====
        const firebaseConfig = {
            databaseURL: "https://esp32-5d620-default-rtdb.firebaseio.com/"
        };
        
        // Инициализиране на Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        
        // ===== Променливи за статусите =====
        let spot1Status = "Зареждане...";
        let spot2Status = "Зареждане...";
        let spot1Distance = -1;
        let spot2Distance = -1;
        let lastUpdateTime = null;
        
        // ===== Инициализиране на картата =====
        const centerLat = 42.8768;
        const centerLng = 25.3179;
        const map = L.map('map').setView([centerLat, centerLng], 18.5);
        
        // Добавяне на слой OpenStreetMap
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
            maxZoom: 22
        }).addTo(map);
        
        // По-големи размери за паркоместата
        const parkingWidth = 3.0;
        const parkingLength = 6.0;
        const spaceBetween = 0.5;
        
        // Функция за преобразуване на метри в градуси
        function metersToDegrees(meters) {
            return meters / 111111;
        }
        
        // Цветове за различните места (по-тъмни за заети, по-светли за свободни)
        const colorsEmpty = ['#4CAF50', '#4CAF50', '#4CAF50', '#4CAF50'];
        const colorsOccupied = ['#f44336', '#f44336', '#4CAF50', '#4CAF50'];
        
        // Референции към полигоните на паркоместата
        let parkingPolygons = [];
        let parkingLabels = [];
        
        // Създаване на 4 паркоместа
        function createParkingSpots() {
            parkingPolygons = [];
            parkingLabels = [];
            
            for (let i = 0; i < 4; i++) {
                const offsetLng = metersToDegrees(i * (parkingWidth + spaceBetween));
                const totalWidth = 4 * parkingWidth + 3 * spaceBetween;
                const centerOffset = metersToDegrees(totalWidth / 2);
                
                const spotLat = centerLat;
                const spotLng = centerLng + offsetLng - centerOffset;
                
                const halfWidth = metersToDegrees(parkingWidth) / 2;
                const halfLength = metersToDegrees(parkingLength) / 2;
                
                // Ъглите на правоъгълника
                const corners = [
                    [spotLat - halfLength, spotLng - halfWidth],
                    [spotLat - halfLength, spotLng + halfWidth],
                    [spotLat + halfLength, spotLng + halfWidth],
                    [spotLat + halfLength, spotLng - halfWidth]
                ];
                
                // Определяне на цвета според статуса
                let fillColor = colorsEmpty[i];
                if (i === 0 && spot1Status === "ЗАЕТО") fillColor = colorsOccupied[i];
                if (i === 1 && spot2Status === "ЗАЕТО") fillColor = colorsOccupied[i];
                
                // Създаване на паркомястото
                const parkingSpace = L.polygon(corners, {
                    color: '#000000',
                    fillColor: fillColor,
                    fillOpacity: 0.7,
                    weight: 1.5,
                    className: 'parking-space'
                }).addTo(map);
                
                parkingPolygons.push(parkingSpace);
                
                // Добавяне на номер
                const label = L.marker([spotLat, spotLng], {
                    icon: L.divIcon({
                        className: 'parking-label',
                        html: `<div style="
                            background: white; 
                            color: ${fillColor}; 
                            font-weight: bold; 
                            font-size: 18px; 
                            width: 32px; 
                            height: 32px; 
                            border-radius: 50%; 
                            display: flex; 
                            align-items: center; 
                            justify-content: center;
                            border: 2px solid ${fillColor};
                            box-shadow: 0 2px 6px rgba(0,0,0,0.2);
                            font-family: Arial, sans-serif;
                        ">${i + 1}</div>`,
                        iconSize: [32, 32],
                        iconAnchor: [16, 16]
                    })
                }).addTo(map);
                
                parkingLabels.push(label);
                
                // Информация при клик
                let statusText = "ПРАЗНО";
                let statusColor = "#4CAF50";
                
                if (i === 0) {
                    statusText = spot1Status;
                    statusColor = spot1Status === "ЗАЕТО" ? "#f44336" : "#4CAF50";
                } else if (i === 1) {
                    statusText = spot2Status;
                    statusColor = spot2Status === "ЗАЕТО" ? "#f44336" : "#4CAF50";
                }
                
                parkingSpace.bindPopup(`
                    <div style="text-align: center; min-width: 200px;">
                        <div style="display: inline-block; background: ${fillColor}; color: white; width: 32px; height: 32px; border-radius: 50%; line-height: 32px; font-weight: bold; margin-bottom: 8px;">
                            ${i + 1}
                        </div>
                        <h3 style="margin: 0 0 8px; color: ${fillColor};">Паркомясто ${i + 1}</h3>
                        <p style="margin: 0 0 10px; font-size: 14px; color: #555;">
                            ул. "Епископ Софроний", Габрово
                        </p>
                        <div style="text-align: left; font-size: 13px; background: #f8f9fa; padding: 10px; border-radius: 4px;">
                            <div style="margin-bottom: 5px;">
                                <strong>Статус:</strong> 
                                <span style="color: ${statusColor}; font-weight: bold;">${statusText}</span>
                            </div>
                            ${i < 2 ? `<div><strong>Разстояние:</strong> ${i === 0 ? spot1Distance : spot2Distance} см</div>` : ''}
                        </div>
                    </div>
                `);
            }
        }
        
        // ===== Firebase слушатели =====
        function setupFirebaseListeners() {
            // Слушател за място 1
            database.ref('parking/spot1').on('value', (snapshot) => {
                const data = snapshot.val();
                if (data) {
                    spot1Distance = data.distance || -1;
                    spot1Status = data.status || "ГРЕШКА";
                    
                    // Актуализиране на UI
                    updateSpotStatus(1, spot1Status, spot1Distance);
                    updateMapColors();
                    updateLastUpdateTime();
                }
            });
            
            // Слушател за място 2
            database.ref('parking/spot2').on('value', (snapshot) => {
                const data = snapshot.val();
                if (data) {
                    spot2Distance = data.distance || -1;
                    spot2Status = data.status || "ГРЕШКА";
                    
                    // Актуализиране на UI
                    updateSpotStatus(2, spot2Status, spot2Distance);
                    updateMapColors();
                    updateLastUpdateTime();
                }
            });
            
            console.log("Firebase слушатели са активирани");
        }
        
        // ===== UI функции =====
        function updateSpotStatus(spotNumber, status, distance) {
            const statusElement = document.getElementById(`status${spotNumber}`);
            const statusClass = status === "ЗАЕТО" ? "status-occupied" : 
                               status === "ПРАЗНО" ? "status-empty" : "status-error";
            
            statusElement.textContent = status;
            statusElement.className = `status-text ${statusClass}`;
            
            // Актуализиране на дистанцията в tooltip
            if (spotNumber <= 2) {
                console.log(`Място ${spotNumber}: ${status} (${distance} см)`);
            }
        }
        
        function updateMapColors() {
            // Актуализиране на цветовете на паркоместата
            for (let i = 0; i < parkingPolygons.length; i++) {
                let fillColor = colorsEmpty[i];
                
                if (i === 0 && spot1Status === "ЗАЕТО") fillColor = colorsOccupied[i];
                if (i === 1 && spot2Status === "ЗАЕТО") fillColor = colorsOccupied[i];
                
                parkingPolygons[i].setStyle({ fillColor: fillColor });
                
                // Актуализиране на цвета на номера
                if (parkingLabels[i]) {
                    parkingLabels[i].setIcon(L.divIcon({
                        className: 'parking-label',
                        html: `<div style="
                            background: white; 
                            color: ${fillColor}; 
                            font-weight: bold; 
                            font-size: 18px; 
                            width: 32px; 
                            height: 32px; 
                            border-radius: 50%; 
                            display: flex; 
                            align-items: center; 
                            justify-content: center;
                            border: 2px solid ${fillColor};
                            box-shadow: 0 2px 6px rgba(0,0,0,0.2);
                            font-family: Arial, sans-serif;
                        ">${i + 1}</div>`,
                        iconSize: [32, 32],
                        iconAnchor: [16, 16]
                    }));
                }
            }
        }
        
        function updateLastUpdateTime() {
            lastUpdateTime = new Date();
            const timeString = lastUpdateTime.toLocaleTimeString('bg-BG');
            document.getElementById('lastUpdate').textContent = 
                `Последна актуализация: ${timeString}`;
        }
        
        function manualRefresh() {
            // Ръчно актуализиране на данните
            database.ref('parking').once('value').then((snapshot) => {
                const data = snapshot.val();
                if (data) {
                    if (data.spot1) {
                        spot1Distance = data.spot1.distance || -1;
                        spot1Status = data.spot1.status || "ГРЕШКА";
                        updateSpotStatus(1, spot1Status, spot1Distance);
                    }
                    if (data.spot2) {
                        spot2Distance = data.spot2.distance || -1;
                        spot2Status = data.spot2.status || "ГРЕШКА";
                        updateSpotStatus(2, spot2Status, spot2Distance);
                    }
                    updateMapColors();
                    updateLastUpdateTime();
                    
                    alert(`Данните са актуализирани!\nМясто 1: ${spot1Status}\nМясто 2: ${spot2Status}`);
                }
            }).catch((error) => {
                console.error("Грешка при ръчно актуализиране:", error);
                alert("Грешка при свързване с Firebase!");
            });
        }
        
        // ===== Инициализация =====
        function init() {
            // Създаване на паркоместата
            createParkingSpots();
            
            // Настройване на Firebase слушатели
            setupFirebaseListeners();
            
            locationMarker.bindPopup(`
                <div style="text-align: center; min-width: 180px;">
                    <h3 style="margin: 0 0 5px; color: #d71920;">ул. "Епископ Софроний"</h3>
                    <p style="margin: 0; font-size: 14px;">
                        Габрово, Централен район
                    </p>
                    <p style="margin: 5px 0 0; font-size: 12px; color: #555;">
                        4 обозначени паркоместа
                    </p>
                    <p style="margin: 5px 0 0; font-size: 11px; color: #777;">
                        Реални данни от сензори за места 1 и 2
                    </p>
                </div>
            `);
            
            console.log("Картата и Firebase са инициализирани");
            
            // Първоначално ръчно зареждане на данни
            setTimeout(manualRefresh, 1000);
        }
        
        // Стартиране на приложението
        init();
        
        // Показване на информация в конзолата
        console.log("Система за мониторинг на паркинг места");
        console.log("Връзка с Firebase: " + firebaseConfig.databaseURL);
        console.log("Място 1 и 2: реални данни от сензори");
        console.log("Място 3 и 4: демонстрационни данни");
    </script>
</body>
</html>
